{% extends "base.html" %} {% block head %}
<style>
  .category-header {
    display: flex;
    align-items: center;
    margin-bottom: 20px;
    padding: 20px;
    background: #fff;
    border-radius: 10px;
    box-shadow: 0 0 15px rgba(0, 0, 0, 0.05);
  }

  .category-icon {
    width: 60px;
    height: 60px;
    display: flex;
    align-items: center;
    justify-content: center;
    margin-right: 20px;
    font-size: 2rem;
    border-radius: 12px;
  }

  .category-title {
    font-size: 1.5rem;
    font-weight: 600;
    margin-bottom: 5px;
    line-height: 1.2;
  }

  .category-description {
    color: #6c757d;
  }

  .site-card {
    display: block;
    text-decoration: none;
    color: inherit;
    background: white;
    border-radius: 10px;
    box-shadow: 0 2px 8px rgba(0, 0, 0, 0.08);
    overflow: hidden;
    transition: all 0.3s ease;
    margin-bottom: 20px;
    position: relative;
  }

  .site-card:hover {
    transform: translateY(-5px);
    box-shadow: 0 8px 15px rgba(0, 0, 0, 0.1);
  }

  .site-header {
    display: flex;
    padding: 15px;
  }

  .site-icon {
    width: 40px;
    height: 40px;
    display: flex;
    align-items: center;
    justify-content: center;
    margin-right: 15px;
    border-radius: 8px;
    overflow: hidden;
  }

  .site-icon img {
    width: 100%;
    height: 100%;
    object-fit: contain;
  }

  .site-text {
    flex: 1;
  }

  .site-title {
    font-weight: 600;
    margin-bottom: 5px;
    line-height: 1.2;
  }

  .site-description {
    color: #6c757d;
    font-size: 0.875rem;
    display: -webkit-box;
    -webkit-line-clamp: 2;
    -webkit-box-orient: vertical;
    overflow: hidden;
  }

  .site-tooltip {
    visibility: hidden;
    position: absolute;
    bottom: 120%;
    left: 50%;
    transform: translateX(-50%);
    background-color: rgba(0, 0, 0, 0.8);
    color: white;
    padding: 10px 15px;
    border-radius: 6px;
    width: 90%;
    max-width: 300px;
    z-index: 100;
    opacity: 0;
    transition: opacity 0.3s, visibility 0.3s;
    font-size: 0.9rem;
    text-align: left;
    box-shadow: 0 4px 8px rgba(0, 0, 0, 0.15);
    pointer-events: none;
  }

  .site-tooltip::after {
    content: "";
    position: absolute;
    top: 100%;
    left: 50%;
    transform: translateX(-50%);
    border-width: 8px;
    border-style: solid;
    border-color: rgba(0, 0, 0, 0.8) transparent transparent transparent;
  }

  .site-card:hover .site-tooltip {
    visibility: visible;
    opacity: 1;
  }

  .site-full-description {
    display: none;
    position: absolute;
    bottom: 100%;
    left: 0;
    width: 100%;
    background-color: rgba(255, 255, 255, 0.98);
    padding: 15px;
    border-radius: 10px;
    box-shadow: 0 4px 12px rgba(0, 0, 0, 0.15);
    color: #333;
    z-index: 10;
    font-size: 0.9rem;
    line-height: 1.5;
    word-wrap: break-word;
    max-width: 100%;
    animation: fadeIn 0.2s ease-in-out;
    border: 1px solid #e0e0e0;
  }

  @keyframes fadeIn {
    from {
      opacity: 0;
      transform: translateY(10px);
    }
    to {
      opacity: 1;
      transform: translateY(0);
    }
  }

  .site-card:hover .site-full-description {
    display: block;
  }

  /* 拖拽相关样式 */
  .drag-handle {
    position: absolute;
    right: 10px;
    top: 50%;
    transform: translateY(-50%);
    cursor: move;
    color: #ccc;
    font-size: 18px;
    opacity: 0.5;
    transition: opacity 0.2s ease;
    display: none;
  }

  .site-card:hover .drag-handle {
    display: block;
  }

  .drag-handle:hover {
    opacity: 1;
    color: #7049f0;
  }

  .site-card.dragging {
    cursor: grabbing;
    opacity: 0.8;
    z-index: 1000;
    background-color: #f8f9fa;
    box-shadow: 0 15px 25px rgba(0, 0, 0, 0.15);
  }

  .drag-instructions {
    background-color: #e9f5ff;
    color: #0c63e4;
    padding: 10px 15px;
    border-radius: 8px;
    margin-bottom: 15px;
    display: flex;
    align-items: center;
    font-size: 14px;
    opacity: 0;
    transition: opacity 0.3s ease;
  }

  .drag-instructions.active {
    opacity: 1;
  }

  .drag-instructions i {
    margin-right: 5px;
    font-size: 16px;
  }

  .description-popup {
    display: none;
    position: fixed;
    background-color: white;
    border: 1px solid #ddd;
    padding: 10px 15px;
    border-radius: 8px;
    box-shadow: 0 5px 15px rgba(0, 0, 0, 0.2);
    z-index: 1000;
    max-width: 300px;
    font-size: 14px;
    color: #333;
    line-height: 1.5;
  }

  /* 自定义tooltip样式 */
  .custom-tooltip {
    position: fixed;
    z-index: 9999;
    display: none;
    padding: 10px 15px;
    background-color: rgba(0, 0, 0, 0.8);
    color: white;
    border-radius: 4px;
    min-width: 100px;
    max-width: 300px;
    width: auto;
    box-shadow: 0 2px 10px rgba(0, 0, 0, 0.2);
    font-size: 14px;
    line-height: 1.5;
    pointer-events: none;
    transition: opacity 0.2s;
    white-space: normal;
  }

  /* 添加统一的箭头样式 */
  .custom-tooltip::after {
    content: "";
    position: absolute;
    width: 0;
    height: 0;
    border-left: 8px solid transparent;
    border-right: 8px solid transparent;
    border-top: 8px solid rgba(0, 0, 0, 0.8);
    bottom: -8px;
    left: 50%;
    margin-left: -8px;
  }

  /* 当tooltip显示在卡片下方时的箭头 */
  .custom-tooltip.bottom-arrow::after {
    border-top: none;
    border-bottom: 8px solid rgba(0, 0, 0, 0.8);
    top: -8px;
    bottom: auto;
  }

  /* 添加多行显示样式 */
  .custom-tooltip.multiline {
    white-space: normal;
    width: 300px;
  }
</style>
{% endblock %} {% block content %}
<div class="container py-4">
  <nav aria-label="breadcrumb">
    <ol class="breadcrumb">
      <li class="breadcrumb-item">
        <a href="{{ url_for('main.index') }}">首页</a>
      </li>
      <li class="breadcrumb-item active" aria-current="page">
        {{ category.name }}
      </li>
    </ol>
  </nav>

  <div
    class="category-header"
    style="background: linear-gradient(135deg, {{ category.color or '#3498db' }} 0%, {{ category.color or '#3498db' }}90 100%); color: white;"
  >
    <div
      class="category-icon"
      style="background-color: rgba(255, 255, 255, 0.2)"
    >
      <i class="{{ category.icon or 'bi bi-collection' }}"></i>
    </div>
    <div>
      <h1 class="category-title">{{ category.name }}</h1>
      {% if category.description %}
      <div class="category-description">{{ category.description }}</div>
      {% endif %}
    </div>
  </div>

  <div class="row">
    {% if current_user.is_authenticated and current_user.is_admin %}
    <div class="col-12 mb-3">
      <div class="drag-instructions active">
        <i class="bi bi-info-circle-fill me-1"></i>
        长按卡片可拖动排序，排序会自动保存
      </div>
    </div>
    {% endif %}

    <div
      class="card-container {% if current_user.is_authenticated and current_user.is_admin %}draggable{% endif %}"
      data-category-id="{{ category.id }}"
    >
      {% for website in websites %}
      <a
        href="{{ url_for('main.site', id=website.id) }}"
        class="site-card {% if current_user.is_authenticated and current_user.is_admin %}draggable{% endif %}"
        data-id="{{ website.id }}"
        data-sort="{{ website.sort_order }}"
        title="{{ website.description }}"
        data-bs-toggle="tooltip"
        data-bs-title="{{ website.description }}"
      >
        {% if current_user.is_authenticated and current_user.is_admin %}
        <div class="drag-handle" title="拖动排序">
          <i class="bi bi-grip-vertical"></i>
        </div>
        {% endif %}
        <div class="site-header">
          <div class="site-icon">
            {% if website.icon %}
            <img src="{{ website.icon }}" alt="{{ website.title }}" />
            {% else %}
            <i class="bi bi-globe text-primary"></i>
            {% endif %}
          </div>
          <div class="site-text">
            <h5 class="site-title">{{ website.title }}</h5>
            <p class="site-description">{{ website.description }}</p>
          </div>
        </div>
      </a>
      {% else %}
      <div class="col-12 text-center py-5">
        <div class="text-muted">
          <i class="bi bi-emoji-frown fs-1"></i>
          <p class="mt-3">该分类下还没有网站</p>
        </div>
      </div>
      {% endfor %}
    </div>
  </div>
</div>
{% endblock %} {% block scripts %} {% if current_user.is_authenticated and
current_user.is_admin %}
<script>
  document.addEventListener("DOMContentLoaded", function () {
    console.log("分类页面加载完成，正在初始化拖拽功能");

    // 拖拽排序相关代码
    const cardContainer = document.querySelector(".card-container.draggable");
    console.log("卡片容器:", cardContainer);

    if (cardContainer) {
      enableDragSort(cardContainer);
    } else {
      console.error("未找到可拖拽的卡片容器");
    }

    // 拖拽状态
    let dragStartTime = 0;
    let longPressTimer;
    let draggedCard = null;

    function enableDragSort(container) {
      const cards = container.querySelectorAll(".site-card.draggable");
      console.log("找到可拖拽卡片数量:", cards.length);

      cards.forEach((card, index) => {
        console.log(`初始化卡片 ${index + 1}:`, card.dataset.id);

        // 长按开始拖拽
        card.addEventListener("mousedown", handleMouseDown);
        card.addEventListener("touchstart", handleTouchStart, {
          passive: false,
        });

        function handleMouseDown(e) {
          // 只响应左键点击
          if (e.button !== 0) return;

          e.preventDefault();
          startLongPress(card, e.clientX, e.clientY);
        }

        function handleTouchStart(e) {
          e.preventDefault(); // 阻止触摸时的默认行为
          const touch = e.touches[0];
          startLongPress(card, touch.clientX, touch.clientY);
        }

        // 拖动句柄点击直接激活拖拽
        const dragHandle = card.querySelector(".drag-handle");
        if (dragHandle) {
          dragHandle.addEventListener("mousedown", function (e) {
            e.stopPropagation(); // 阻止冒泡
            e.preventDefault();
            console.log("通过拖拽句柄开始拖拽");
            startDragging(card, container, e.clientX, e.clientY);
          });

          dragHandle.addEventListener(
            "touchstart",
            function (e) {
              e.stopPropagation();
              e.preventDefault();
              const touch = e.touches[0];
              console.log("通过拖拽句柄开始触摸拖拽");
              startDragging(card, container, touch.clientX, touch.clientY);
            },
            { passive: false }
          );
        }
      });
    }

    function startLongPress(card, x, y) {
      console.log("开始长按", card.dataset.id);
      dragStartTime = Date.now();
      const initialX = x;
      const initialY = y;

      clearTimeout(longPressTimer);
      longPressTimer = setTimeout(() => {
        console.log("长按时间到，开始拖拽");
        startDragging(card, card.parentNode, initialX, initialY);
      }, 300); // 长按300ms激活拖拽

      // 监听鼠标抬起和移出
      document.addEventListener("mouseup", cancelLongPress);
      document.addEventListener("mouseleave", cancelLongPress);
      document.addEventListener("touchend", cancelLongPress);
      document.addEventListener("touchcancel", cancelLongPress);

      function cancelLongPress() {
        console.log("取消长按");
        clearTimeout(longPressTimer);
        document.removeEventListener("mouseup", cancelLongPress);
        document.removeEventListener("mouseleave", cancelLongPress);
        document.removeEventListener("touchend", cancelLongPress);
        document.removeEventListener("touchcancel", cancelLongPress);
      }
    }

    function startDragging(card, container, initialX, initialY) {
      if (draggedCard) {
        console.log("已有卡片正在拖拽中，忽略");
        return;
      }

      console.log("开始拖拽:", card.dataset.id);
      draggedCard = card;
      draggedCard.classList.add("dragging");

      // 创建卡片克隆作为拖拽时的视觉提示
      const rect = card.getBoundingClientRect();

      // 设置卡片初始位置
      draggedCard.style.position = "fixed";
      draggedCard.style.zIndex = "1000";
      draggedCard.style.left = rect.left + "px";
      draggedCard.style.top = rect.top + "px";
      draggedCard.style.width = rect.width + "px";
      draggedCard.style.height = rect.height + "px";

      // 禁用卡片的点击链接功能
      draggedCard.originalHref = draggedCard.getAttribute("href");
      draggedCard.removeAttribute("href");

      // 移动到鼠标/触摸位置
      moveAt(initialX, initialY);

      // 监听移动事件
      document.addEventListener("mousemove", onMouseMove);
      document.addEventListener("touchmove", onTouchMove, { passive: false });

      // 监听释放事件
      document.addEventListener("mouseup", onMouseUp);
      document.addEventListener("touchend", onMouseUp);

      function onMouseMove(e) {
        moveAt(e.clientX, e.clientY);
      }

      function onTouchMove(e) {
        e.preventDefault();
        const touch = e.touches[0];
        moveAt(touch.clientX, touch.clientY);
      }

      function moveAt(x, y) {
        if (!draggedCard) return;

        // 移动被拖拽的卡片
        draggedCard.style.left = x - draggedCard.offsetWidth / 2 + "px";
        draggedCard.style.top = y - draggedCard.offsetHeight / 2 + "px";

        const elemBelow = getElementBelow(x, y);

        if (elemBelow && elemBelow !== draggedCard) {
          // 执行卡片排序
          const rect = elemBelow.getBoundingClientRect();
          const middleY = rect.y + rect.height / 2;

          if (y < middleY && elemBelow.previousElementSibling !== draggedCard) {
            elemBelow.parentNode.insertBefore(draggedCard, elemBelow);
          } else if (
            y >= middleY &&
            elemBelow.nextElementSibling !== draggedCard
          ) {
            elemBelow.parentNode.insertBefore(
              draggedCard,
              elemBelow.nextElementSibling
            );
          }
        }
      }

      function onMouseUp() {
        console.log("拖拽结束");
        document.removeEventListener("mousemove", onMouseMove);
        document.removeEventListener("touchmove", onTouchMove);
        document.removeEventListener("mouseup", onMouseUp);
        document.removeEventListener("touchend", onMouseUp);

        if (!draggedCard) return;

        // 停止拖拽
        draggedCard.classList.remove("dragging");
        draggedCard.style.position = "";
        draggedCard.style.zIndex = "";
        draggedCard.style.left = "";
        draggedCard.style.top = "";
        draggedCard.style.width = "";
        draggedCard.style.height = "";

        // 恢复链接功能
        if (draggedCard.originalHref) {
          draggedCard.setAttribute("href", draggedCard.originalHref);
          draggedCard.originalHref = null;
        }

        // 更新排序并发送到服务器
        updateSortOrder(container);

        // 重置拖拽状态
        draggedCard = null;
      }
    }

    function getElementBelow(x, y) {
      if (!draggedCard) return null;

      // 临时隐藏当前拖拽的元素，以便获取下面的元素
      const originalDisplay = draggedCard.style.display;
      draggedCard.style.display = "none";

      // 获取指定位置的元素
      let elemBelow = document.elementFromPoint(x, y);

      // 恢复拖拽元素的显示
      draggedCard.style.display = originalDisplay;

      // 查找最近的.site-card元素
      if (elemBelow) {
        return elemBelow.closest(".site-card");
      }

      return null;
    }

    function updateSortOrder(container) {
      const cards = container.querySelectorAll(".site-card");
      if (!cards.length) {
        console.log("没有找到卡片，不更新排序");
        return;
      }

      const categoryId = container.dataset.categoryId;
      const items = [];

      // 按新顺序重新分配权重
      cards.forEach((card, index) => {
        const websiteId = parseInt(card.dataset.id);
        if (isNaN(websiteId)) {
          console.error("卡片ID无效:", card.dataset.id);
          return;
        }

        const newSortOrder = index * 10; // 每10个单位，方便将来插入

        // 修改data-sort属性
        card.dataset.sort = newSortOrder;

        items.push({
          id: websiteId,
          sort_order: newSortOrder,
        });
      });

      console.log("更新排序:", items);

      // 发送排序数据到服务器
      fetch("/api/website/update_order", {
        method: "POST",
        headers: {
          "Content-Type": "application/json",
        },
        body: JSON.stringify({
          category_id: categoryId,
          items: items,
        }),
        credentials: "same-origin",
      })
        .then((response) => response.json())
        .then((data) => {
          if (data.success) {
            console.log("排序保存成功");
          } else {
            console.error("保存排序失败:", data.message);
          }
        })
        .catch((error) => {
          console.error("保存排序出错:", error);
        });
    }
  });
</script>
{% endif %}

<script>
  document.addEventListener("DOMContentLoaded", function () {
    // 创建浮动描述框
    const popup = document.createElement("div");
    popup.className = "description-popup";
    document.body.appendChild(popup);

    // 获取所有卡片
    const cards = document.querySelectorAll(".site-card");

    cards.forEach((card) => {
      const description = card
        .querySelector(".site-description")
        .textContent.trim();

      // 鼠标进入显示描述
      card.addEventListener("mouseenter", function (e) {
        popup.textContent = description;
        popup.style.display = "block";

        // 计算位置 - 放在卡片上方
        const rect = card.getBoundingClientRect();
        popup.style.left =
          rect.left + rect.width / 2 - popup.offsetWidth / 2 + "px";
        popup.style.top = rect.top - popup.offsetHeight - 10 + "px"; // 10px的间隔

        // 确保弹窗不超出视口
        const popupRect = popup.getBoundingClientRect();
        if (popupRect.left < 10) {
          popup.style.left = "10px";
        } else if (popupRect.right > window.innerWidth - 10) {
          popup.style.left = window.innerWidth - 10 - popup.offsetWidth + "px";
        }

        if (popupRect.top < 10) {
          // 如果上方空间不足，则显示在卡片下方
          popup.style.top = rect.bottom + 10 + "px";
        }
      });

      // 鼠标移出隐藏描述
      card.addEventListener("mouseleave", function () {
        popup.style.display = "none";
      });

      // 鼠标移动时更新位置
      card.addEventListener("mousemove", function (e) {
        // 弹窗跟随鼠标位置微调，但保持在卡片上方
        const rect = card.getBoundingClientRect();
        const offsetX = (e.clientX - rect.left) / rect.width - 0.5; // -0.5到0.5的值

        // 根据鼠标在卡片中的位置轻微调整弹窗位置
        const popupRect = popup.getBoundingClientRect();
        let newLeft =
          rect.left + rect.width / 2 - popup.offsetWidth / 2 + offsetX * 30;

        // 边界检查
        if (newLeft < 10) {
          newLeft = 10;
        } else if (newLeft + popup.offsetWidth > window.innerWidth - 10) {
          newLeft = window.innerWidth - 10 - popup.offsetWidth;
        }

        popup.style.left = newLeft + "px";
      });
    });

    // 页面滚动时隐藏弹窗
    window.addEventListener("scroll", function () {
      popup.style.display = "none";
    });
  });
</script>

<script>
  document.addEventListener("DOMContentLoaded", function () {
    // 移除可能存在的旧tooltip
    const oldTooltips = document.querySelectorAll(".custom-tooltip");
    oldTooltips.forEach((tooltip) => tooltip.remove());

    // 创建单个全局tooltip元素
    const tooltip = document.createElement("div");
    tooltip.classList.add("custom-tooltip");
    document.body.appendChild(tooltip);

    // 全局变量跟踪上次显示的卡片
    let lastDisplayedCard = null;

    // 获取所有网站卡片
    const siteCards = document.querySelectorAll(".site-card");

    // 存储当前激活的卡片
    let activeCard = null;

    // 为图标添加错误处理
    document.querySelectorAll(".site-icon img").forEach((img) => {
      img.onerror = function () {
        this.style.display = "none";
        const icon = document.createElement("i");
        icon.className = "bi bi-globe text-primary";
        this.parentNode.appendChild(icon);
      };
    });

    // 更新tooltip位置
    function updateTooltipPosition(card) {
      const description = card.getAttribute("data-description");
      if (!description) return;

      // 获取卡片位置
      const cardRect = card.getBoundingClientRect();

      // 设置tooltip内容
      tooltip.textContent = description;

      // 判断是否需要多行显示
      if (description.length > 50) {
        tooltip.classList.add("multiline");
        tooltip.style.width = "300px";
      } else {
        tooltip.classList.remove("multiline");

        // 确保隐藏状态并重置宽度进行测量
        const oldDisplay = tooltip.style.display;
        tooltip.style.display = "block";
        tooltip.style.visibility = "hidden";
        tooltip.style.width = "auto";

        // 获取实际宽度
        const tempWidth = tooltip.offsetWidth;
        const tooltipWidth = Math.max(Math.min(tempWidth, 300), 100);

        // 恢复原来的显示状态
        tooltip.style.visibility = "visible";
        tooltip.style.display = oldDisplay;

        // 设置宽度
        tooltip.style.width = tooltipWidth + "px";
      }

      // 检查下方空间是否足够
      const bottomSpace = window.innerHeight - cardRect.bottom;
      const tooltipHeight = tooltip.offsetHeight;

      // 计算tooltip的初始位置（水平居中对齐卡片）
      const tooltipWidth = tooltip.offsetWidth;
      let leftPos = cardRect.left + cardRect.width / 2 - tooltipWidth / 2;

      // 边界检查 - 水平方向
      if (leftPos < 10) {
        leftPos = 10;
      } else if (leftPos + tooltipWidth > window.innerWidth - 10) {
        leftPos = window.innerWidth - tooltipWidth - 10;
      }

      tooltip.style.left = leftPos + "px";

      // 优先显示在下方（除非空间不足）
      if (bottomSpace >= tooltipHeight + 15) {
        // 显示在下方，箭头指向上方
        tooltip.style.top = cardRect.bottom + 10 + "px";
        tooltip.classList.add("bottom-arrow");
      } else {
        // 下方空间不足，显示在上方，箭头指向下方
        tooltip.style.top = cardRect.top - tooltipHeight - 10 + "px";
        tooltip.classList.remove("bottom-arrow");

        // 检查上方空间是否足够，如果不够就再次调整
        if (cardRect.top < tooltipHeight + 15) {
          // 上下都不够空间，强制显示在下方并调整垂直位置
          tooltip.style.top = window.innerHeight - tooltipHeight - 10 + "px";
          tooltip.classList.add("bottom-arrow");
        }
      }
    }

    // 监听鼠标事件
    siteCards.forEach((card) => {
      const description = card.getAttribute("title");

      // 保存描述到自定义属性
      if (description && description.trim()) {
        card.setAttribute("data-description", description);
      }

      // 移除原始title以避免浏览器默认tooltip
      card.removeAttribute("title");
      card.removeAttribute("data-bs-toggle");
      card.removeAttribute("data-bs-title");

      if (description && description.trim()) {
        card.addEventListener("mouseenter", function (e) {
          // 重置之前的卡片
          if (lastDisplayedCard && lastDisplayedCard !== card) {
            tooltip.style.display = "none";
          }

          activeCard = card;
          lastDisplayedCard = card;
          tooltip.style.display = "block";
          updateTooltipPosition(card);
        });

        card.addEventListener("mouseleave", function () {
          tooltip.style.display = "none";
          activeCard = null;
        });
      }
    });

    // 监听滚动事件
    window.addEventListener("scroll", function () {
      if (activeCard) {
        updateTooltipPosition(activeCard);
      }
    });

    // 监听窗口大小变化
    window.addEventListener("resize", function () {
      if (activeCard) {
        updateTooltipPosition(activeCard);
      }
    });
  });
</script>
{% endblock %}
