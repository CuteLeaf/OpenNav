{% extends "base.html" %} {% block head %}
<link
  rel="stylesheet"
  href="{{ url_for('static', filename='css/variables.css') }}"
/>
<link
  rel="stylesheet"
  href="{{ url_for('static', filename='css/layout.css') }}"
/>
<link
  rel="stylesheet"
  href="{{ url_for('static', filename='css/card.css') }}"
/>
<link
  rel="stylesheet"
  href="{{ url_for('static', filename='css/contextMenu.css') }}"
/>
<link
  rel="stylesheet"
  href="{{ url_for('static', filename='css/modal.css') }}"
/>
<style>
  .category-header {
    display: flex;
    align-items: center;
    margin-bottom: 20px;
    padding: 20px;
    background: #fff;
    border-radius: 10px;
    box-shadow: 0 0 15px rgba(0, 0, 0, 0.05);
  }

  .category-icon {
    width: 60px;
    height: 60px;
    display: flex;
    align-items: center;
    justify-content: center;
    margin-right: 20px;
    font-size: 2rem;
    border-radius: 12px;
  }

  .category-title {
    font-size: 1.5rem;
    font-weight: 600;
    margin-bottom: 5px;
    line-height: 1.2;
  }

  .category-description {
    color: #6c757d;
  }
</style>
{% endblock %} {% block content %}
<div class="container py-4">
  <nav aria-label="breadcrumb">
    <ol class="breadcrumb">
      <li class="breadcrumb-item">
        <a href="{{ url_for('main.index') }}">首页</a>
      </li>
      <li class="breadcrumb-item active" aria-current="page">
        {{ category.name }}
      </li>
    </ol>
  </nav>

  <div
    class="category-header"
    style="background: linear-gradient(135deg, {{ category.color or '#3498db' }} 0%, {{ category.color or '#3498db' }}90 100%); color: white;"
  >
    <div
      class="category-icon"
      style="background-color: rgba(255, 255, 255, 0.2)"
    >
      <i class="{{ category.icon or 'bi bi-collection' }}"></i>
    </div>
    <div>
      <h1 class="category-title">{{ category.name }}</h1>
      {% if category.description %}
      <div class="category-description">{{ category.description }}</div>
      {% endif %}
    </div>
  </div>

  <div class="row">
    {% if current_user.is_authenticated and current_user.is_admin %} {% endif %}

    <div
      class="card-container {% if current_user.is_authenticated and current_user.is_admin %}draggable{% endif %}"
      data-category-id="{{ category.id }}"
    >
      {% for website in websites %}
      <a
        href="{{ url_for('main.site', id=website.id) }}"
        class="site-card {% if current_user.is_authenticated and current_user.is_admin %}draggable{% endif %}"
        data-id="{{ website.id }}"
        data-sort="{{ website.sort_order }}"
        title="{{ website.description }}"
        data-bs-toggle="tooltip"
        data-bs-placement="bottom"
      >
        {% if current_user.is_authenticated and current_user.is_admin %}
        <div class="drag-handle" title="拖动排序">
          <i class="bi bi-grip-vertical"></i>
        </div>
        {% endif %}
        <div class="site-header">
          <div class="site-icon">
            {% if website.icon %}
            <img src="{{ website.icon }}" alt="{{ website.title }}" />
            {% else %}
            <i class="bi bi-globe text-primary"></i>
            {% endif %}
          </div>
          <div class="site-text">
            <h5 class="site-title">{{ website.title }}</h5>
            <p class="site-description">{{ website.description }}</p>
          </div>
        </div>
      </a>
      {% else %}
      <div class="col-12 text-center py-5">
        <div class="text-muted">
          <i class="bi bi-emoji-frown fs-1"></i>
          <p class="mt-3">该分类下还没有网站</p>
        </div>
      </div>
      {% endfor %}
    </div>
  </div>
</div>

{# 卡片右键菜单 #}
<div id="contextMenu" class="context-menu" style="display: none">
  <div class="context-menu-item" id="visitLink">
    <i class="bi bi-box-arrow-up-right"></i> 访问链接
  </div>
  {% if current_user.is_authenticated %} {% if current_user.is_admin %}
  <div class="context-menu-item" id="editLink">
    <i class="bi bi-pencil"></i> 修改链接
  </div>
  <div class="context-menu-item" id="addLink">
    <i class="bi bi-plus-circle"></i> 添加链接
  </div>
  <div class="context-menu-item" id="deleteLink">
    <i class="bi bi-trash"></i> 删除链接
  </div>
  {% endif %}
  <div class="context-menu-item" id="shareSite">
    <i class="bi bi-share"></i> 分享
  </div>
  {% endif %}
</div>

{# 修改链接对话框 #}
<div class="modal-overlay" id="editLinkModal" style="display: none">
  <div class="edit-modal">
    <div class="modal-header">
      <h4>修改链接</h4>
      <button class="modal-close" id="closeModal">
        <i class="bi bi-x"></i>
      </button>
    </div>
    <div class="modal-body">
      <form id="editLinkForm">
        <div class="form-group">
          <label for="editTitle">标题</label>
          <input type="text" id="editTitle" class="modal-input" required />
        </div>
        <div class="form-group">
          <label for="editUrl">链接地址</label>
          <div class="url-input-group">
            <input type="url" id="editUrl" class="modal-input" required />
            <button
              type="button"
              id="fetchInfo"
              class="icon-fetch-btn"
              title="获取网站信息"
            >
              <i class="bi bi-cloud-download"></i>
            </button>
          </div>
        </div>
        <div class="form-group">
          <label for="editIcon">图标地址</label>
          <input
            type="url"
            id="editIcon"
            class="modal-input"
            placeholder="输入图标URL或留空使用默认图标"
          />
        </div>
        <div class="form-group">
          <label for="editDescription">描述</label>
          <textarea
            id="editDescription"
            class="modal-input"
            rows="5"
          ></textarea>
        </div>
        <div class="form-group">
          <label>访问权限</label>
          <div class="d-flex gap-3">
            <div class="form-check">
              <input
                class="form-check-input"
                type="radio"
                name="editPrivacy"
                id="editPublic"
                value="0"
                checked
              />
              <label class="form-check-label" for="editPublic">
                <i class="bi bi-globe"></i> 公开
              </label>
            </div>
            <div class="form-check">
              <input
                class="form-check-input"
                type="radio"
                name="editPrivacy"
                id="editPrivate"
                value="1"
              />
              <label class="form-check-label" for="editPrivate">
                <i class="bi bi-lock"></i> 私有
              </label>
            </div>
          </div>
        </div>
        <input type="hidden" id="editLinkId" />
        <div class="modal-actions">
          <button type="button" class="modal-btn cancel" id="cancelEdit">
            取消
          </button>
          <button type="submit" class="modal-btn save">保存</button>
        </div>
      </form>
    </div>
  </div>
</div>
{% endblock %} {% block scripts %} {% if current_user.is_authenticated and
current_user.is_admin %}
<script>
  document.addEventListener("DOMContentLoaded", function () {
    console.log("分类页面加载完成，正在初始化拖拽功能");

    // 拖拽排序相关代码
    const cardContainer = document.querySelector(".card-container.draggable");
    console.log("卡片容器:", cardContainer);

    if (cardContainer) {
      enableDragSort(cardContainer);
    } else {
      console.error("未找到可拖拽的卡片容器");
    }

    // 拖拽状态
    let dragStartTime = 0;
    let longPressTimer;
    let draggedCard = null;

    function enableDragSort(container) {
      const cards = container.querySelectorAll(".site-card.draggable");
      console.log("找到可拖拽卡片数量:", cards.length);

      cards.forEach((card, index) => {
        console.log(`初始化卡片 ${index + 1}:`, card.dataset.id);

        // 长按开始拖拽
        card.addEventListener("mousedown", handleMouseDown);
        card.addEventListener("touchstart", handleTouchStart, {
          passive: false,
        });

        function handleMouseDown(e) {
          // 只响应左键点击
          if (e.button !== 0) return;

          e.preventDefault();
          startLongPress(card, e.clientX, e.clientY);
        }

        function handleTouchStart(e) {
          e.preventDefault(); // 阻止触摸时的默认行为
          const touch = e.touches[0];
          startLongPress(card, touch.clientX, touch.clientY);
        }

        // 拖动句柄点击直接激活拖拽
        const dragHandle = card.querySelector(".drag-handle");
        if (dragHandle) {
          dragHandle.addEventListener("mousedown", function (e) {
            e.stopPropagation(); // 阻止冒泡
            e.preventDefault();
            console.log("通过拖拽句柄开始拖拽");
            startDragging(card, container, e.clientX, e.clientY);
          });

          dragHandle.addEventListener(
            "touchstart",
            function (e) {
              e.stopPropagation();
              e.preventDefault();
              const touch = e.touches[0];
              console.log("通过拖拽句柄开始触摸拖拽");
              startDragging(card, container, touch.clientX, touch.clientY);
            },
            { passive: false }
          );
        }
      });
    }

    function startLongPress(card, x, y) {
      console.log("开始长按", card.dataset.id);
      dragStartTime = Date.now();
      const initialX = x;
      const initialY = y;

      clearTimeout(longPressTimer);
      longPressTimer = setTimeout(() => {
        console.log("长按时间到，开始拖拽");
        startDragging(card, card.parentNode, initialX, initialY);
      }, 300); // 长按300ms激活拖拽

      // 监听鼠标抬起和移出
      document.addEventListener("mouseup", cancelLongPress);
      document.addEventListener("mouseleave", cancelLongPress);
      document.addEventListener("touchend", cancelLongPress);
      document.addEventListener("touchcancel", cancelLongPress);

      function cancelLongPress() {
        console.log("取消长按");
        clearTimeout(longPressTimer);
        document.removeEventListener("mouseup", cancelLongPress);
        document.removeEventListener("mouseleave", cancelLongPress);
        document.removeEventListener("touchend", cancelLongPress);
        document.removeEventListener("touchcancel", cancelLongPress);
      }
    }

    function startDragging(card, container, initialX, initialY) {
      if (draggedCard) {
        console.log("已有卡片正在拖拽中，忽略");
        return;
      }

      console.log("开始拖拽:", card.dataset.id);
      draggedCard = card;
      draggedCard.classList.add("dragging");

      // 创建卡片克隆作为拖拽时的视觉提示
      const rect = card.getBoundingClientRect();

      // 设置卡片初始位置
      draggedCard.style.position = "fixed";
      draggedCard.style.zIndex = "1000";
      draggedCard.style.left = rect.left + "px";
      draggedCard.style.top = rect.top + "px";
      draggedCard.style.width = rect.width + "px";
      draggedCard.style.height = rect.height + "px";

      // 禁用卡片的点击链接功能
      draggedCard.originalHref = draggedCard.getAttribute("href");
      draggedCard.removeAttribute("href");

      // 移动到鼠标/触摸位置
      moveAt(initialX, initialY);

      // 监听移动事件
      document.addEventListener("mousemove", onMouseMove);
      document.addEventListener("touchmove", onTouchMove, { passive: false });

      // 监听释放事件
      document.addEventListener("mouseup", onMouseUp);
      document.addEventListener("touchend", onMouseUp);

      function onMouseMove(e) {
        moveAt(e.clientX, e.clientY);
      }

      function onTouchMove(e) {
        e.preventDefault();
        const touch = e.touches[0];
        moveAt(touch.clientX, touch.clientY);
      }

      function moveAt(x, y) {
        if (!draggedCard) return;

        // 移动被拖拽的卡片
        draggedCard.style.left = x - draggedCard.offsetWidth / 2 + "px";
        draggedCard.style.top = y - draggedCard.offsetHeight / 2 + "px";

        const elemBelow = getElementBelow(x, y);

        if (elemBelow && elemBelow !== draggedCard) {
          // 执行卡片排序
          const rect = elemBelow.getBoundingClientRect();
          const middleY = rect.y + rect.height / 2;

          if (y < middleY && elemBelow.previousElementSibling !== draggedCard) {
            elemBelow.parentNode.insertBefore(draggedCard, elemBelow);
          } else if (
            y >= middleY &&
            elemBelow.nextElementSibling !== draggedCard
          ) {
            elemBelow.parentNode.insertBefore(
              draggedCard,
              elemBelow.nextElementSibling
            );
          }
        }
      }

      function onMouseUp() {
        console.log("拖拽结束");
        document.removeEventListener("mousemove", onMouseMove);
        document.removeEventListener("touchmove", onTouchMove);
        document.removeEventListener("mouseup", onMouseUp);
        document.removeEventListener("touchend", onMouseUp);

        if (!draggedCard) return;

        // 停止拖拽
        draggedCard.classList.remove("dragging");
        draggedCard.style.position = "";
        draggedCard.style.zIndex = "";
        draggedCard.style.left = "";
        draggedCard.style.top = "";
        draggedCard.style.width = "";
        draggedCard.style.height = "";

        // 恢复链接功能
        if (draggedCard.originalHref) {
          draggedCard.setAttribute("href", draggedCard.originalHref);
          draggedCard.originalHref = null;
        }

        // 更新排序并发送到服务器
        updateSortOrder(container);

        // 重置拖拽状态
        draggedCard = null;
      }
    }

    function getElementBelow(x, y) {
      if (!draggedCard) return null;

      // 临时隐藏当前拖拽的元素，以便获取下面的元素
      const originalDisplay = draggedCard.style.display;
      draggedCard.style.display = "none";

      // 获取指定位置的元素
      let elemBelow = document.elementFromPoint(x, y);

      // 恢复拖拽元素的显示
      draggedCard.style.display = originalDisplay;

      // 查找最近的.site-card元素
      if (elemBelow) {
        return elemBelow.closest(".site-card");
      }

      return null;
    }

    function updateSortOrder(container) {
      const cards = container.querySelectorAll(".site-card");
      if (!cards.length) {
        console.log("没有找到卡片，不更新排序");
        return;
      }

      const categoryId = container.dataset.categoryId;
      const items = [];
      const totalCards = cards.length; // 获取当前分类下的总链接数

      // 按新顺序重新分配权重
      cards.forEach((card, index) => {
        const websiteId = parseInt(card.dataset.id);
        if (isNaN(websiteId)) {
          console.error("卡片ID无效:", card.dataset.id);
          return;
        }

        // 修改排序逻辑：从前到后分配权重，靠前的权重大，靠后的权重小
        const newSortOrder = (totalCards - index) * 10; // 每10个单位，方便将来插入

        // 修改data-sort属性
        card.dataset.sort = newSortOrder;

        items.push({
          id: websiteId,
          sort_order: newSortOrder,
        });
      });

      console.log("更新排序:", items);

      // 发送排序数据到服务器
      fetch("/api/website/update_order", {
        method: "POST",
        headers: {
          "Content-Type": "application/json",
        },
        body: JSON.stringify({
          category_id: categoryId,
          items: items,
        }),
        credentials: "same-origin",
      })
        .then((response) => response.json())
        .then((data) => {
          if (data.success) {
            console.log("排序保存成功");
          } else {
            console.error("保存排序失败:", data.message);
          }
        })
        .catch((error) => {
          console.error("保存排序出错:", error);
        });
    }
  });
</script>
{% endif %}

<script>
  document.addEventListener("DOMContentLoaded", function () {
    // 注意：图标错误处理已移至base.html全局处理

    // 初始化所有Bootstrap tooltips
    var tooltipTriggerList = [].slice.call(
      document.querySelectorAll('[data-bs-toggle="tooltip"]')
    );
    var tooltipList = tooltipTriggerList.map(function (tooltipTriggerEl) {
      return new bootstrap.Tooltip(tooltipTriggerEl, {
        placement: "bottom",
        fallbackPlacements: ["top"],
      });
    });
  });
</script>

<script src="{{ url_for('static', filename='js/contextMenu.js') }}"></script>
<script src="{{ url_for('static', filename='js/modal.js') }}"></script>
{% endblock %}
