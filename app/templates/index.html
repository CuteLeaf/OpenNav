{% extends "base.html" %} {% block head %}
<link rel="preconnect" href="https://fonts.googleapis.com" />
<link rel="preconnect" href="https://fonts.gstatic.com" crossorigin />
<link
  href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500&family=Poppins:wght@500;600&display=swap"
  rel="stylesheet"
/>
<style>
  body {
    background: #f5f7fa;
    padding-top: 60px;
    min-height: 100vh;
  }

  /* 顶部导航栏 */
  .top-navbar {
    position: fixed;
    top: 0;
    left: 0;
    width: 100%;
    height: 60px;
    background: #fff;
    box-shadow: 0 2px 10px rgba(0, 0, 0, 0.1);
    z-index: 1040;
    display: flex;
    align-items: center;
    padding: 0 15px;
  }

  .navbar-logo {
    display: flex;
    align-items: center;
    font-size: 1.25rem;
    font-weight: 600;
    color: #7049f0;
    text-decoration: none;
    margin-left: 15px;
  }

  .navbar-logo:hover {
    color: #4a88fc;
  }

  .menu-toggle {
    width: 40px;
    height: 40px;
    display: flex;
    align-items: center;
    justify-content: center;
    font-size: 1.5rem;
    color: #333;
    cursor: pointer;
    border-radius: 50%;
    transition: all 0.3s ease;
  }

  .menu-toggle:hover {
    background: rgba(0, 0, 0, 0.05);
  }

  .search-bar {
    flex-grow: 1;
    margin: 0 20px;
    position: relative;
    max-width: 600px;
  }

  .search-input {
    width: 100%;
    padding: 10px 20px;
    border-radius: 30px;
    border: 1px solid #eee;
    outline: none;
    transition: all 0.3s ease;
  }

  .search-input:focus {
    border-color: #7049f0;
    box-shadow: 0 0 0 3px rgba(112, 73, 240, 0.2);
  }

  .search-button {
    position: absolute;
    right: 10px;
    top: 50%;
    transform: translateY(-50%);
    background: transparent;
    border: none;
    color: #666;
    font-size: 1.2rem;
    cursor: pointer;
  }

  .user-actions {
    display: flex;
    align-items: center;
  }

  .user-action-btn {
    margin-left: 10px;
    width: 40px;
    height: 40px;
    border-radius: 50%;
    display: flex;
    align-items: center;
    justify-content: center;
    color: #333;
    font-size: 1.2rem;
    transition: all 0.3s ease;
    cursor: pointer;
  }

  .user-action-btn:hover {
    background: rgba(0, 0, 0, 0.05);
  }

  /* 侧边栏基础样式 */
  .sidebar {
    position: fixed;
    top: 60px;
    left: -220px;
    width: 220px;
    height: calc(100vh - 60px);
    background: rgba(255, 255, 255, 0.9);
    backdrop-filter: blur(10px);
    -webkit-backdrop-filter: blur(10px);
    box-shadow: 2px 0 10px rgba(0, 0, 0, 0.1);
    z-index: 1030;
    transition: all 0.3s ease;
    overflow-y: auto;
    padding: 0;
    display: flex;
    flex-direction: column;
  }

  /* 侧边栏显示状态 */
  body.sidebar-active .sidebar {
    left: 0;
  }

  /* 遮罩层 */
  .sidebar-overlay {
    position: fixed;
    top: 60px;
    left: 0;
    width: 100%;
    height: calc(100% - 60px);
    background: rgba(0, 0, 0, 0.5);
    z-index: 1025;
    display: none;
    opacity: 0;
    transition: opacity 0.3s ease;
  }

  /* 遮罩层激活 - 仅在移动设备上显示 */
  @media (max-width: 768px) {
    body.sidebar-active .sidebar-overlay {
      display: block;
      opacity: 1;
    }
  }

  /* 桌面设备上不需要遮罩 */
  @media (min-width: 769px) {
    body.sidebar-active .sidebar-overlay {
      display: none;
    }
  }

  /* 侧边栏顶部部分 */
  .sidebar-header {
    padding: 20px;
    background: #f8f9fa;
    border-bottom: 1px solid #eee;
  }

  /* 访问统计 */
  .visitor-stats {
    display: flex;
    gap: 10px;
    margin-bottom: 0;
  }

  .visitor-badge {
    display: inline-flex;
    align-items: center;
    padding: 6px 12px;
    background: white;
    border-radius: 30px;
    font-size: 0.85rem;
    color: #5f6368;
    box-shadow: 0 1px 3px rgba(0, 0, 0, 0.1);
  }

  .visitor-badge i {
    margin-right: 5px;
    color: #3498db;
  }

  /* 侧边栏内部组件样式 */
  .sidebar-content {
    flex: 1;
    overflow-y: auto;
    padding: 15px 0;
  }

  .sidebar-group {
    margin-bottom: 15px;
  }

  .sidebar-group-title {
    font-size: 0.9rem;
    padding: 10px 20px;
    color: #9aa0a6;
    font-weight: 500;
    text-transform: uppercase;
    letter-spacing: 0.5px;
  }

  .sidebar-menu {
    list-style: none;
    padding: 0;
    margin: 0;
  }

  .sidebar-menu-item {
    display: block;
  }

  .sidebar-menu-link {
    display: flex;
    align-items: center;
    padding: 12px 20px;
    text-decoration: none;
    color: #333;
    transition: all 0.3s ease;
    font-size: 0.95rem;
    border-left: 3px solid transparent;
  }

  .sidebar-menu-link:hover {
    background: rgba(112, 73, 240, 0.1);
    color: #7049f0;
    border-left-color: #7049f0;
  }

  .sidebar-menu-icon {
    margin-right: 10px;
    font-size: 1.1rem;
    width: 25px;
    text-align: center;
    color: #5f6368;
  }

  /* 侧边栏底部 */
  .sidebar-footer {
    padding: 15px 20px;
    background: #f8f9fa;
    border-top: 1px solid #eee;
  }

  .auth-buttons {
    display: flex;
    gap: 10px;
  }

  .auth-button {
    flex: 1;
    display: flex;
    align-items: center;
    justify-content: center;
    padding: 8px;
    border-radius: 5px;
    border: none;
    cursor: pointer;
    transition: all 0.3s ease;
    text-decoration: none;
    font-size: 0.9rem;
  }

  .auth-button.login {
    background: linear-gradient(135deg, #7049f0 0%, #4a88fc 100%);
    color: white;
  }

  .auth-button.login:hover {
    background: linear-gradient(135deg, #6540d9 0%, #3e78e8 100%);
  }

  .auth-button.register {
    background: #f8f9fa;
    border: 1px solid #ddd;
    color: #333;
  }

  .auth-button.register:hover {
    background: #eee;
  }

  .auth-button i {
    margin-right: 5px;
  }

  .user-box {
    display: flex;
    align-items: center;
    padding: 10px;
    background: #f1f8fe;
    border-radius: 5px;
  }

  .user-avatar {
    width: 40px;
    height: 40px;
    border-radius: 50%;
    background: #3498db;
    color: white;
    display: flex;
    align-items: center;
    justify-content: center;
    font-size: 1.2rem;
    margin-right: 10px;
  }

  .user-info {
    flex: 1;
  }

  .user-name {
    font-weight: 600;
    font-size: 0.95rem;
    color: #333;
  }

  .user-actions-list {
    list-style: none;
    padding: 0;
    margin: 10px 0 0;
  }

  .user-action-item {
    margin-bottom: 5px;
  }

  .user-action-link {
    display: flex;
    align-items: center;
    font-size: 0.85rem;
    color: #5f6368;
    text-decoration: none;
    padding: 5px;
    border-radius: 3px;
    transition: all 0.3s ease;
  }

  .user-action-link:hover {
    background: rgba(52, 152, 219, 0.1);
    color: #3498db;
  }

  .user-action-link i {
    margin-right: 5px;
    font-size: 0.9rem;
    width: 20px;
    text-align: center;
  }

  /* 主内容区 */
  .main-content {
    transition: padding-left 0.3s ease;
    padding: 20px 30px 20px 250px; /* 默认状态：侧边栏展开时，内容区域留有空间给侧边栏 */
  }

  /* 侧边栏隐藏时的内容区调整 */
  body:not(.sidebar-active) .main-content {
    padding-left: 65px; /* 侧边栏隐藏时，内容区域左侧保留一定距离 */
  }

  /* 分类标题样式 */
  .category-heading {
    font-size: 1.25rem;
    margin-bottom: 20px;
    padding-bottom: 10px;
    border-bottom: none;
    display: flex;
    align-items: center;
    font-weight: 600;
    color: #2c3e50;
    position: relative;
    font-family: "Poppins", "Segoe UI", -apple-system, BlinkMacSystemFont,
      sans-serif;
    letter-spacing: -0.01em;
  }

  .category-heading::after {
    content: "";
    position: absolute;
    bottom: 0;
    left: 0;
    width: 50px;
    height: 3px;
    background: linear-gradient(to right, #7049f0, #4a88fc);
    border-radius: 3px;
  }

  .category-icon {
    margin-right: 10px;
    width: 32px;
    height: 32px;
    background: linear-gradient(135deg, #7049f0 0%, #4a88fc 100%);
    border-radius: 8px;
    display: flex;
    justify-content: center;
    align-items: center;
    color: white;
    font-size: 1rem;
    box-shadow: 0 3px 6px rgba(0, 0, 0, 0.1);
  }

  /* 网站卡片样式 */
  .site-card {
    background: rgba(255, 255, 255, 0.95);
    border-radius: 10px;
    padding: 12px 16px;
    transition: all 0.35s cubic-bezier(0.23, 1, 0.32, 1);
    box-shadow: 0 2px 8px rgba(0, 0, 0, 0.05);
    text-decoration: none;
    color: #333;
    border: 1px solid rgba(0, 0, 0, 0.05);
    height: 90px;
    display: flex;
    position: relative;
    overflow: hidden;
    margin: 0 10px 20px 10px;
    width: calc(20% - 20px);
    float: none;
  }

  .site-card:hover {
    transform: translateY(-3px);
    box-shadow: 0 15px 30px rgba(0, 0, 0, 0.1);
    border-color: rgba(112, 73, 240, 0.3);
  }

  .site-card::before {
    content: "";
    position: absolute;
    top: 0;
    left: 0;
    right: 0;
    height: 100%;
    background: linear-gradient(
      90deg,
      rgba(0, 0, 0, 0) 0%,
      rgba(112, 73, 240, 0.03) 30%,
      rgba(74, 136, 252, 0.03) 70%,
      rgba(0, 0, 0, 0) 100%
    );
    z-index: 0;
    transform: translateX(-100%);
    transition: transform 0.8s ease;
  }

  .site-card:hover::before {
    transform: translateX(100%);
  }

  .site-card::after {
    content: "";
    position: absolute;
    width: 25px;
    height: 25px;
    border-radius: 50%;
    background: linear-gradient(135deg, #7049f0 0%, #4a88fc 100%);
    filter: blur(20px);
    opacity: 0;
    z-index: -1;
    transition: all 0.4s ease;
    top: 50%;
    left: 0;
    transform: translateY(-50%);
  }

  .site-card:hover::after {
    opacity: 0.8;
    left: 100%;
    transition-duration: 0.8s;
  }

  .site-header {
    display: flex;
    align-items: center;
    width: 100%;
    z-index: 1;
  }

  .site-icon {
    width: 45px;
    height: 45px;
    margin-right: 15px;
    display: flex;
    align-items: center;
    justify-content: center;
    border-radius: 8px;
    overflow: hidden;
    background: #f5f9ff;
    border: 1px solid rgba(112, 73, 240, 0.1);
    box-shadow: 0 2px 6px rgba(0, 0, 0, 0.04);
    transition: all 0.3s ease;
    flex-shrink: 0;
    position: relative;
  }

  .site-card:hover .site-icon {
    transform: translateX(3px);
    background: #f0f0ff;
    border-color: rgba(112, 73, 240, 0.3);
    box-shadow: 0 4px 10px rgba(74, 136, 252, 0.15);
  }

  .site-icon::after {
    content: "";
    position: absolute;
    top: -10px;
    left: -10px;
    right: -10px;
    bottom: -10px;
    border: 1px solid rgba(112, 73, 240, 0.2);
    border-radius: 12px;
    opacity: 0;
    transform: scale(1.2);
    transition: all 0.3s ease;
  }

  .site-card:hover .site-icon::after {
    opacity: 1;
    transform: scale(1);
  }

  .site-icon img {
    max-width: 75%;
    max-height: 75%;
    object-fit: contain;
    transition: transform 0.3s ease;
    filter: saturate(0.9);
  }

  .site-card:hover .site-icon img {
    transform: scale(1.1);
    filter: saturate(1.1);
  }

  .site-icon i {
    font-size: 1.3rem;
    color: #7049f0;
    transition: all 0.3s ease;
  }

  .site-card:hover .site-icon i {
    transform: scale(1.1);
    color: #4a88fc;
  }

  .site-text {
    flex: 1;
    overflow: hidden;
    min-width: 0;
    transition: all 0.3s ease;
  }

  .site-card:hover .site-text {
    transform: translateX(5px);
  }

  .site-title {
    font-weight: 600;
    font-size: 0.95rem;
    margin: 0 0 5px 0;
    color: #2c3e50;
    line-height: 1.3;
    letter-spacing: -0.01em;
    font-family: "Poppins", "Segoe UI", -apple-system, BlinkMacSystemFont,
      sans-serif;
    white-space: nowrap;
    overflow: hidden;
    text-overflow: ellipsis;
    transition: color 0.3s ease;
    position: relative;
    padding-right: 12px;
  }

  .site-title::after {
    content: "";
    position: absolute;
    height: 6px;
    width: 6px;
    border-radius: 50%;
    background: rgba(112, 73, 240, 0);
    right: 0;
    top: 50%;
    transform: translateY(-50%);
    transition: all 0.3s ease;
  }

  .site-card:hover .site-title::after {
    background: rgba(112, 73, 240, 1);
    box-shadow: 0 0 8px rgba(112, 73, 240, 0.6);
  }

  .site-card:hover .site-title {
    color: #7049f0;
    text-shadow: 0 0 1px rgba(112, 73, 240, 0.1);
  }

  .site-description {
    font-size: 0.75rem;
    color: #94a3b8;
    margin: 0;
    line-height: 1.4;
    font-family: "Inter", "Segoe UI", -apple-system, BlinkMacSystemFont,
      sans-serif;
    opacity: 0.9;
    overflow: hidden;
    text-overflow: ellipsis;
    display: -webkit-box;
    -webkit-line-clamp: 2; /* 限制最多显示两行 */
    -webkit-box-orient: vertical;
    word-wrap: break-word; /* 允许长单词断行 */
    font-weight: 400;
    letter-spacing: 0.01em;
  }

  .site-card:hover .site-description {
    color: #64748b;
  }

  /* 响应式调整 */
  @media (max-width: 1400px) {
    .site-card {
      width: calc(25% - 20px);
    }
  }

  @media (max-width: 1200px) {
    .site-card {
      width: calc(33.333% - 20px);
    }
  }

  @media (max-width: 768px) {
    .site-card {
      width: calc(50% - 20px);
    }
  }

  @media (max-width: 576px) {
    .site-card {
      width: calc(100% - 20px);
    }
  }

  /* 自定义5列栅格系统 */
  .col-lg-20 {
    position: relative;
    width: 100%;
    padding-right: 15px;
    padding-left: 15px;
  }

  @media (min-width: 992px) {
    .col-lg-20 {
      flex: 0 0 20%;
      max-width: 20%;
    }
  }

  /* 按钮样式 */
  .btn-outline-primary {
    color: #fff;
    border-color: rgba(255, 255, 255, 0.6);
    background: rgba(255, 255, 255, 0.1);
  }

  .btn-outline-primary:hover {
    color: #fff;
    background: rgba(112, 73, 240, 0.5);
    border-color: #fff;
  }

  /* 添加主搜索框样式 */
  .main-search-container {
    width: 100%;
    margin-bottom: 30px;
  }

  .main-search-form {
    width: 100%;
    max-width: 700px;
    margin: 0 auto;
  }

  .search-input-group {
    position: relative;
    width: 100%;
  }

  .main-search-input {
    width: 100%;
    height: 50px;
    padding: 10px 60px 10px 20px;
    font-size: 1rem;
    border-radius: 10px;
    border: 1px solid rgba(112, 73, 240, 0.2);
    background: rgba(255, 255, 255, 0.95);
    box-shadow: 0 4px 20px rgba(0, 0, 0, 0.05);
    outline: none;
    transition: all 0.3s ease;
  }

  .main-search-input:focus {
    border-color: #7049f0;
    box-shadow: 0 4px 25px rgba(112, 73, 240, 0.15);
  }

  .main-search-button {
    position: absolute;
    right: 5px;
    top: 50%;
    transform: translateY(-50%);
    width: 40px;
    height: 40px;
    border-radius: 8px;
    border: none;
    background: linear-gradient(135deg, #7049f0 0%, #4a88fc 100%);
    color: white;
    font-size: 1.1rem;
    cursor: pointer;
    transition: all 0.3s ease;
    display: flex;
    align-items: center;
    justify-content: center;
  }

  .main-search-button:hover {
    background: linear-gradient(135deg, #6540d9 0%, #3e78e8 100%);
    transform: translateY(-50%) scale(1.05);
  }

  @media (max-width: 768px) {
    .main-search-input {
      height: 45px;
      font-size: 0.9rem;
    }

    .main-search-button {
      width: 35px;
      height: 35px;
    }
  }

  /* 搜索相关样式 */
  .search-clear-button {
    position: absolute;
    right: 50px;
    top: 50%;
    transform: translateY(-50%);
    width: 30px;
    height: 30px;
    border-radius: 8px;
    border: none;
    background: transparent;
    color: #94a3b8;
    font-size: 0.9rem;
    cursor: pointer;
    transition: all 0.3s ease;
    display: flex;
    align-items: center;
    justify-content: center;
  }

  .search-clear-button:hover {
    color: #7049f0;
    background-color: rgba(112, 73, 240, 0.1);
  }

  .search-keyword {
    display: inline-block;
    font-size: 0.9rem;
    color: #7049f0;
    margin-left: 8px;
    padding: 3px 10px;
    background-color: rgba(112, 73, 240, 0.1);
    border-radius: 15px;
  }

  /* 搜索结果卡片样式 */
  #resultsContent {
    display: flex;
    flex-wrap: wrap;
    gap: 15px;
    margin-top: 20px;
  }

  .website-item {
    background: #fff;
    border-radius: 10px;
    box-shadow: 0 2px 10px rgba(0, 0, 0, 0.05);
    width: calc(20% - 12px);
    transition: transform 0.2s, box-shadow 0.2s;
    overflow: hidden;
  }

  @media (max-width: 1200px) {
    .website-item {
      width: calc(25% - 12px);
    }
  }

  @media (max-width: 992px) {
    .website-item {
      width: calc(33.33% - 10px);
    }
  }

  @media (max-width: 768px) {
    .website-item {
      width: calc(50% - 8px);
    }
  }

  @media (max-width: 576px) {
    .website-item {
      width: 100%;
    }
  }

  .website-item:hover {
    transform: translateY(-3px);
    box-shadow: 0 5px 15px rgba(0, 0, 0, 0.1);
  }

  .website-link {
    display: block;
    padding: 15px;
    text-decoration: none;
    color: inherit;
  }

  .website-icon-container {
    width: 45px;
    height: 45px;
    display: flex;
    align-items: center;
    justify-content: center;
    margin-bottom: 10px;
    background: #f8f9fa;
    border-radius: 10px;
  }

  .website-icon {
    max-width: 32px;
    max-height: 32px;
  }

  .default-icon {
    color: #4285f4;
    font-size: 20px;
  }

  .website-title {
    font-weight: 600;
    margin-bottom: 5px;
    color: #333;
    font-size: 16px;
    white-space: nowrap;
    overflow: hidden;
    text-overflow: ellipsis;
  }

  .website-desc {
    color: #777;
    font-size: 13px;
    overflow: hidden;
    text-overflow: ellipsis;
    white-space: nowrap;
  }

  /* 卡片容器样式 */
  .card-container {
    margin: 0 -10px;
    overflow: hidden;
    display: flex;
    flex-wrap: wrap;
  }

  /* 移除搜索框的原生叉叉按钮 */
  input[type="search"]::-webkit-search-cancel-button {
    -webkit-appearance: none;
  }

  /* 右键菜单样式 */
  .context-menu {
    position: absolute;
    background: white;
    border-radius: 8px;
    box-shadow: 0 4px 15px rgba(0, 0, 0, 0.15);
    padding: 8px 0;
    min-width: 150px;
    z-index: 1050;
    border: 1px solid rgba(112, 73, 240, 0.1);
  }

  .context-menu-item {
    padding: 8px 15px;
    cursor: pointer;
    font-size: 14px;
    display: flex;
    align-items: center;
    color: #333;
    transition: all 0.2s ease;
  }

  .context-menu-item:hover {
    background-color: rgba(112, 73, 240, 0.08);
    color: #7049f0;
  }

  .context-menu-item i {
    margin-right: 8px;
    font-size: 14px;
  }

  /* 模态框样式 */
  .modal-overlay {
    position: fixed;
    top: 0;
    left: 0;
    right: 0;
    bottom: 0;
    background-color: rgba(0, 0, 0, 0.5);
    display: flex;
    align-items: center;
    justify-content: center;
    z-index: 2000;
    backdrop-filter: blur(5px);
  }

  .edit-modal {
    background: white;
    border-radius: 12px;
    width: 90%;
    max-width: 450px;
    box-shadow: 0 10px 30px rgba(0, 0, 0, 0.2);
    overflow: hidden;
    animation: modalFadeIn 0.3s ease;
  }

  @keyframes modalFadeIn {
    from {
      transform: translateY(20px);
      opacity: 0;
    }
    to {
      transform: translateY(0);
      opacity: 1;
    }
  }

  .modal-header {
    display: flex;
    justify-content: space-between;
    align-items: center;
    padding: 16px 20px;
    border-bottom: 1px solid #eee;
  }

  .modal-header h4 {
    margin: 0;
    font-weight: 600;
    color: #333;
  }

  .modal-close {
    background: transparent;
    border: none;
    font-size: 20px;
    cursor: pointer;
    color: #aaa;
    transition: color 0.2s;
  }

  .modal-close:hover {
    color: #7049f0;
  }

  .modal-body {
    padding: 20px;
  }

  .form-group {
    margin-bottom: 15px;
  }

  .form-group label {
    display: block;
    margin-bottom: 6px;
    font-size: 14px;
    color: #555;
    font-weight: 500;
  }

  .modal-input {
    width: 100%;
    padding: 10px 12px;
    border: 1px solid #ddd;
    border-radius: 8px;
    font-size: 14px;
    transition: all 0.2s;
    box-sizing: border-box;
  }

  .modal-input:focus {
    border-color: #7049f0;
    box-shadow: 0 0 0 3px rgba(112, 73, 240, 0.1);
    outline: none;
  }

  .modal-actions {
    display: flex;
    justify-content: flex-end;
    margin-top: 20px;
    gap: 10px;
  }

  .modal-btn {
    padding: 8px 16px;
    border-radius: 6px;
    cursor: pointer;
    font-size: 14px;
    font-weight: 500;
    border: none;
    transition: all 0.2s;
  }

  .modal-btn.cancel {
    background: #f1f1f1;
    color: #555;
  }

  .modal-btn.cancel:hover {
    background: #e5e5e5;
  }

  .modal-btn.save {
    background: linear-gradient(135deg, #7049f0 0%, #4a88fc 100%);
    color: white;
  }

  .modal-btn.save:hover {
    background: linear-gradient(135deg, #6540d9 0%, #3e78e8 100%);
    transform: translateY(-1px);
  }

  /* 链接地址输入组 */
  .url-input-group {
    position: relative;
    display: flex;
  }

  .icon-fetch-btn {
    position: absolute;
    right: 5px;
    top: 50%;
    transform: translateY(-50%);
    width: 32px;
    height: 32px;
    border-radius: 6px;
    border: none;
    background: transparent;
    color: #94a3b8;
    font-size: 0.9rem;
    cursor: pointer;
    transition: all 0.2s;
    display: flex;
    align-items: center;
    justify-content: center;
  }

  .icon-fetch-btn:hover {
    color: #7049f0;
    background-color: rgba(112, 73, 240, 0.1);
  }

  .icon-fetch-btn.loading i {
    animation: spin 1s linear infinite;
  }

  @keyframes spin {
    0% {
      transform: rotate(0deg);
    }
    100% {
      transform: rotate(360deg);
    }
  }
</style>
{% endblock %} {% block content %}

<!-- 顶部导航栏 -->
<div class="top-navbar">
  <div class="menu-toggle" id="menuToggle">
    <i class="bi bi-list"></i>
  </div>

  <a href="{{ url_for('main.index') }}" class="navbar-logo">
    <i class="bi bi-collection me-2"></i> 炫酷导航
  </a>
</div>

<!-- 遮罩层 -->
<div class="sidebar-overlay" id="sidebarOverlay"></div>

<!-- 侧边栏 -->
<div class="sidebar" id="sidebar">
  <!-- 侧边栏内容区 -->
  <div class="sidebar-content">
    <div class="sidebar-group">
      <div class="sidebar-group-title">网站分类</div>
      <ul class="sidebar-menu">
        {% for category in categories %}
        <li class="sidebar-menu-item">
          <a href="#{{ category.name }}" class="sidebar-menu-link">
            <span class="sidebar-menu-icon">
              {% if category.icon %}
              <i
                class="bi bi-{{ category.icon }}"
                style="color: {{ category.color or '#3498db' }}"
              ></i>
              {% else %}
              <i
                class="bi bi-folder"
                style="color: {{ category.color or '#3498db' }}"
              ></i>
              {% endif %}
            </span>
            {{ category.name }}
          </a>
        </li>
        {% endfor %}
      </ul>
    </div>

    <div class="sidebar-group">
      <div class="sidebar-group-title">更多</div>
      <ul class="sidebar-menu">
        <li class="sidebar-menu-item">
          <a href="{{ url_for('main.about') }}" class="sidebar-menu-link">
            <span class="sidebar-menu-icon"
              ><i class="bi bi-info-circle"></i
            ></span>
            关于本站
          </a>
        </li>

        {% if current_user.is_authenticated %}
        <li class="sidebar-menu-item">
          <a href="{{ url_for('auth.logout') }}" class="sidebar-menu-link">
            <span class="sidebar-menu-icon"
              ><i class="bi bi-box-arrow-right"></i
            ></span>
            退出登录
          </a>
        </li>
        {% if current_user.is_admin %}
        <li class="sidebar-menu-item">
          <a href="{{ url_for('admin.index') }}" class="sidebar-menu-link">
            <span class="sidebar-menu-icon"
              ><i class="bi bi-speedometer2"></i
            ></span>
            管理面板
          </a>
        </li>
        {% endif %} {% else %}
        <li class="sidebar-menu-item">
          <a href="{{ url_for('auth.login') }}" class="sidebar-menu-link">
            <span class="sidebar-menu-icon"
              ><i class="bi bi-box-arrow-in-right"></i
            ></span>
            登录
          </a>
        </li>
        <li class="sidebar-menu-item">
          <a href="{{ url_for('auth.register') }}" class="sidebar-menu-link">
            <span class="sidebar-menu-icon"
              ><i class="bi bi-person-plus"></i
            ></span>
            注册
          </a>
        </li>
        {% endif %}
      </ul>
    </div>
  </div>
</div>

<!-- 主内容区域 -->
<div class="main-content" id="mainContent">
  <!-- 搜索区域 -->
  <div class="main-search-container mb-4">
    <form id="searchForm" class="main-search-form">
      <div class="search-input-group">
        <input
          type="search"
          name="q"
          id="searchInput"
          class="main-search-input"
          placeholder="请输入关键字搜索网站"
          autocomplete="off"
        />
        <button type="submit" class="main-search-button">
          <i class="bi bi-search"></i>
        </button>
        <button
          type="button"
          id="clearSearch"
          class="search-clear-button"
          style="display: none"
        >
          <i class="bi bi-x"></i>
        </button>
      </div>
    </form>
  </div>

  <!-- 搜索结果区域 -->
  <div id="searchResults" class="mb-5" style="display: none">
    <div id="resultsContainer">
      <h3 class="category-heading">
        <span class="category-icon">
          <i class="bi bi-search"></i>
        </span>
        搜索结果 <span id="searchKeyword" class="search-keyword"></span>
      </h3>
      <div id="resultsContent">
        <!-- 搜索结果将通过JavaScript动态填充 -->
      </div>
      <div
        id="noResults"
        class="text-center text-muted py-4"
        style="display: none"
      >
        <i class="bi bi-emoji-frown fs-4"></i>
        <p>未找到相关网站</p>
        <p class="text-muted">您可以尝试使用其他关键词，或浏览现有分类</p>
      </div>
    </div>
  </div>

  <!-- 分类内容区域 -->
  <div id="categoriesContainer">
    <!-- 各分类网站 -->
    {% for category in categories %}
    <div id="{{ category.name }}" class="mb-5">
      <h3 class="category-heading">
        <span
          class="category-icon"
          style="background-color: {{ category.color or '#3498db' }};"
        >
          {% if category.icon %}
          <i class="bi bi-{{ category.icon }}"></i>
          {% else %}
          <i class="bi bi-folder"></i>
          {% endif %}
        </span>
        {{ category.name }}
      </h3>

      {% set websites = category.website_list %} {% if websites %}
      <!-- 完全重构卡片容器 -->
      <div
        class="card-container {% if current_user.is_authenticated and current_user.is_admin %}draggable{% endif %}"
        data-category-id="{{ category.id }}"
      >
        {% if current_user.is_authenticated and current_user.is_admin %}
        <div class="drag-instructions" id="dragInstructions-{{ category.id }}">
          <i class="bi bi-info-circle-fill me-1"></i>
          长按卡片可拖动排序，排序会自动保存
        </div>
        {% endif %} {% for website in websites %}
        <a
          href="{{ url_for('main.site', id=website.id) }}"
          class="site-card {% if current_user.is_authenticated and current_user.is_admin %}draggable{% endif %}"
          data-id="{{ website.id }}"
          data-sort="{{ website.sort_order|default(loop.index0*10) }}"
        >
          {% if current_user.is_authenticated and current_user.is_admin %}
          <div class="drag-handle" title="拖动排序">
            <i class="bi bi-grip-vertical"></i>
          </div>
          {% endif %}
          <div class="site-header">
            {% if website.icon %}
            <div class="site-icon">
              <img src="{{ website.icon }}" alt="{{ website.title }}" />
            </div>
            {% else %}
            <div class="site-icon">
              <i class="bi bi-globe text-primary"></i>
            </div>
            {% endif %}
            <div class="site-text">
              <h5 class="site-title">{{ website.title }}</h5>
              <p class="site-description">
                {{ website.description|truncate(60) }}
              </p>
            </div>
          </div>
        </a>
        {% endfor %}
      </div>

      <style>
        .card-container {
          margin: 0 -10px;
          overflow: hidden;
        }
      </style>

      {% if websites|length > 8 %}
      <div class="text-center mt-3">
        <a
          href="{{ url_for('main.category', id=category.id) }}"
          class="btn btn-sm btn-outline-primary"
        >
          查看全部 ({{ websites|length }})
        </a>
      </div>
      {% endif %} {% else %}
      <div class="text-center text-muted py-4">
        <i class="bi bi-emoji-neutral fs-4"></i>
        <p>暂无网站</p>
      </div>
      {% endif %}
    </div>
    {% else %}
    <div class="text-center py-5">
      <div class="display-6 text-muted">
        <i class="bi bi-emoji-dizzy fs-1"></i>
        <p>暂无分类，请管理员添加</p>
      </div>
    </div>
    {% endfor %}
  </div>
</div>

<!-- 卡片右键菜单 -->
<div id="contextMenu" class="context-menu" style="display: none">
  <div class="context-menu-item" id="visitLink">
    <i class="bi bi-box-arrow-up-right"></i> 访问链接
  </div>
  {% if current_user.is_authenticated %} {% if current_user.is_admin %}
  <div class="context-menu-item" id="editLink">
    <i class="bi bi-pencil"></i> 修改链接
  </div>
  <div class="context-menu-item" id="deleteLink">
    <i class="bi bi-trash"></i> 删除链接
  </div>
  {% endif %}
  <div class="context-menu-item" id="addFavorite">
    <i class="bi bi-star"></i> 添加收藏
  </div>
  <div class="context-menu-item" id="shareSite">
    <i class="bi bi-share"></i> 分享
  </div>
  {% endif %}
</div>

<!-- 修改链接对话框 -->
<div class="modal-overlay" id="editLinkModal" style="display: none">
  <div class="edit-modal">
    <div class="modal-header">
      <h4>修改链接</h4>
      <button class="modal-close" id="closeModal">
        <i class="bi bi-x"></i>
      </button>
    </div>
    <div class="modal-body">
      <form id="editLinkForm">
        <div class="form-group">
          <label for="editTitle">标题</label>
          <input type="text" id="editTitle" class="modal-input" required />
        </div>
        <div class="form-group">
          <label for="editUrl">链接地址</label>
          <div class="url-input-group">
            <input type="url" id="editUrl" class="modal-input" required />
            <button
              type="button"
              id="fetchInfo"
              class="icon-fetch-btn"
              title="获取网站信息"
            >
              <i class="bi bi-cloud-download"></i>
            </button>
          </div>
        </div>
        <div class="form-group">
          <label for="editIcon">图标地址</label>
          <input
            type="url"
            id="editIcon"
            class="modal-input"
            placeholder="输入图标URL或留空使用默认图标"
          />
        </div>
        <div class="form-group">
          <label for="editDescription">描述</label>
          <textarea
            id="editDescription"
            class="modal-input"
            rows="3"
          ></textarea>
        </div>
        <input type="hidden" id="editLinkId" />
        <div class="modal-actions">
          <button type="button" class="modal-btn cancel" id="cancelEdit">
            取消
          </button>
          <button type="submit" class="modal-btn save">保存</button>
        </div>
      </form>
    </div>
  </div>
</div>

{% endblock %} {% block scripts %}
<script>
  document.addEventListener("DOMContentLoaded", function () {
    // 获取DOM元素
    const menuToggle = document.getElementById("menuToggle");
    const sidebar = document.getElementById("sidebar");
    const sidebarOverlay = document.getElementById("sidebarOverlay");
    const bodyElement = document.body;

    // 搜索相关元素
    const searchForm = document.getElementById("searchForm");
    const searchInput = document.getElementById("searchInput");
    const clearSearchBtn = document.getElementById("clearSearch");
    const searchResults = document.getElementById("searchResults");
    const searchKeyword = document.getElementById("searchKeyword");
    const resultsContent = document.getElementById("resultsContent");
    const noResults = document.getElementById("noResults");
    const categoriesContainer = document.getElementById("categoriesContainer");

    // 右键菜单相关元素
    const contextMenu = document.getElementById("contextMenu");
    const editLinkBtn = document.getElementById("editLink");
    const visitLinkBtn = document.getElementById("visitLink");
    const addFavoriteBtn = document.getElementById("addFavorite");
    const shareSiteBtn = document.getElementById("shareSite");
    let currentCard = null;

    // 默认显示侧边栏（桌面设备）
    if (window.innerWidth >= 768) {
      bodyElement.classList.add("sidebar-active");
    }

    // 菜单切换功能
    menuToggle.addEventListener("click", function () {
      bodyElement.classList.toggle("sidebar-active");
    });

    // 点击遮罩层关闭侧边栏
    sidebarOverlay.addEventListener("click", function () {
      bodyElement.classList.remove("sidebar-active");
    });

    // 点击链接平滑滚动并关闭侧边栏
    document.querySelectorAll(".sidebar-menu-link").forEach((link) => {
      link.addEventListener("click", function (e) {
        const href = this.getAttribute("href");

        if (href.startsWith("#")) {
          e.preventDefault();
          const targetElement = document.getElementById(href.substring(1));

          if (targetElement) {
            window.scrollTo({
              top: targetElement.offsetTop - 80,
              behavior: "smooth",
            });

            // 在移动设备上关闭侧边栏
            if (window.innerWidth < 768) {
              bodyElement.classList.remove("sidebar-active");
            }

            // 如果在搜索结果页面，先清除搜索
            if (searchResults.style.display !== "none") {
              clearSearch();
            }
          }
        }
      });
    });

    // 监听窗口大小变化
    window.addEventListener("resize", function () {
      const isMobile = window.innerWidth < 768;

      if (isMobile) {
        // 移动设备上默认隐藏侧边栏
        bodyElement.classList.remove("sidebar-active");
      } else {
        // 桌面设备上默认显示侧边栏
        bodyElement.classList.add("sidebar-active");
      }
    });

    // 搜索功能
    searchForm.addEventListener("submit", function (e) {
      e.preventDefault();
      const query = searchInput.value.trim().toLowerCase();

      if (query) {
        // 使用Ajax获取搜索结果
        fetch(`/api/search?q=${encodeURIComponent(query)}`)
          .then((response) => response.json())
          .then((data) => {
            // 清空之前的搜索结果
            resultsContent.innerHTML = "";

            if (data.websites && data.websites.length > 0) {
              // 显示搜索关键词
              searchKeyword.textContent = `"${query}"`;

              // 创建卡片容器
              const cardContainer = document.createElement("div");
              cardContainer.className = "card-container";

              // 根据结果数量添加额外的CSS类
              if (data.websites.length <= 4) {
                cardContainer.classList.add(`results-${data.websites.length}`);
              }

              resultsContent.appendChild(cardContainer);

              // 循环添加搜索结果
              data.websites.forEach((site) => {
                // 使用DOM API创建元素，避免innerHTML注入问题
                const siteCard = document.createElement("a");
                siteCard.href = `/site/${site.id}`;
                siteCard.className = "site-card";

                const siteHeader = document.createElement("div");
                siteHeader.className = "site-header";
                siteCard.appendChild(siteHeader);

                // 创建图标容器
                const iconContainer = document.createElement("div");
                iconContainer.className = "site-icon";

                if (site.icon) {
                  const img = document.createElement("img");
                  img.src = site.icon;
                  img.alt = site.title;
                  iconContainer.appendChild(img);
                } else {
                  const icon = document.createElement("i");
                  icon.className = "bi bi-globe text-primary";
                  iconContainer.appendChild(icon);
                }

                siteHeader.appendChild(iconContainer);

                // 创建文本容器
                const textContainer = document.createElement("div");
                textContainer.className = "site-text";

                const titleEl = document.createElement("h5");
                titleEl.className = "site-title";
                titleEl.textContent = site.title;
                textContainer.appendChild(titleEl);

                const descEl = document.createElement("p");
                descEl.className = "site-description";
                descEl.textContent = site.description || "";
                textContainer.appendChild(descEl);

                siteHeader.appendChild(textContainer);

                // 将卡片添加到结果容器
                cardContainer.appendChild(siteCard);
              });

              // 根据匹配结果数量添加类名
              if (data.websites.length > 0 && data.websites.length <= 4) {
                cardContainer.classList.add(`results-${data.websites.length}`);
              }

              // 显示搜索结果或无结果提示
              if (data.websites.length > 0) {
                noResults.style.display = "none";
              } else {
                noResults.style.display = "block";
              }

              // 隐藏分类容器，显示搜索结果
              categoriesContainer.style.display = "none";
              searchResults.style.display = "block";
            } else {
              // 无结果时显示提示
              noResults.style.display = "block";
            }
          })
          .catch((error) => {
            console.error("搜索出错:", error);
          });
      } else {
        clearSearch();
      }
    });

    // 监听搜索框输入
    searchInput.addEventListener("input", function () {
      if (this.value.trim()) {
        clearSearchBtn.style.display = "flex";
      } else {
        clearSearchBtn.style.display = "none";
        // 如果输入框被清空，自动恢复显示原始内容
        if (searchResults.style.display !== "none") {
          clearSearch();
        }
      }
    });

    // 清除搜索按钮
    clearSearchBtn.addEventListener("click", clearSearch);

    // 执行搜索
    function performSearch(query) {
      // 显示搜索关键词
      searchKeyword.textContent = `"${query}"`;

      // 清空之前的搜索结果
      resultsContent.innerHTML = "";

      // 创建卡片容器
      const cardContainer = document.createElement("div");
      cardContainer.className = "card-container";
      resultsContent.appendChild(cardContainer);

      let matchCount = 0;

      // 搜索并复制匹配的卡片
      document.querySelectorAll(".site-card").forEach((card) => {
        // 获取卡片内部的标题和描述文本
        const titleEl = card.querySelector(".site-title");
        const descEl = card.querySelector(".site-description");

        if (!titleEl || !descEl) return;

        const title = titleEl.textContent.toLowerCase();
        const description = descEl.textContent.toLowerCase();

        if (title.includes(query) || description.includes(query)) {
          // 创建新的卡片元素
          const siteCard = document.createElement("a");
          siteCard.href = card.getAttribute("href");
          siteCard.className = "site-card";

          // 复制内部内容
          siteCard.innerHTML = card.innerHTML;

          // 添加到结果容器
          cardContainer.appendChild(siteCard);
          matchCount++;
        }
      });

      // 根据匹配结果数量添加类名
      if (matchCount > 0 && matchCount <= 4) {
        cardContainer.classList.add(`results-${matchCount}`);
      }
    }

    // 清除搜索
    function clearSearch() {
      searchInput.value = "";
      clearSearchBtn.style.display = "none";
      searchResults.style.display = "none";
      categoriesContainer.style.display = "block";
    }

    // 添加卡片右键菜单功能
    document.addEventListener("contextmenu", function (e) {
      // 检查是否是卡片元素且用户已登录
      {% if current_user.is_authenticated %}
      if (e.target.closest(".site-card")) {
        e.preventDefault();

        // 保存当前操作的卡片
        currentCard = e.target.closest(".site-card");

        // 显示自定义右键菜单
        contextMenu.style.display = "block";
        contextMenu.style.left = e.pageX + "px";
        contextMenu.style.top = e.pageY + "px";
      }
      {% endif %}
    });

    // 点击页面任意位置关闭右键菜单
    document.addEventListener("click", function () {
      contextMenu.style.display = "none";
    });

    // 修改链接按钮点击事件
    editLinkBtn.addEventListener("click", function () {
      if (currentCard) {
        const cardId = currentCard.href.split("/").pop();
        const cardTitle = currentCard.querySelector(".site-title").textContent;
        const cardDesc =
          currentCard.querySelector(".site-description").textContent;
        const cardIcon = currentCard.querySelector(".site-icon img");

        // 填充表单
        document.getElementById("editLinkId").value = cardId;
        document.getElementById("editTitle").value = cardTitle;
        document.getElementById("editUrl").value = ""; // 获取URL需要额外请求
        document.getElementById("editDescription").value = cardDesc;

        if (cardIcon) {
          document.getElementById("editIcon").value = cardIcon.src;
        } else {
          document.getElementById("editIcon").value = "";
        }

        // 从服务器获取完整信息
        fetch(`/site/${cardId}/info`)
          .then((response) => response.json())
          .then((data) => {
            if (data.success) {
              document.getElementById("editUrl").value = data.website.url;
            }
          })
          .catch((error) => {
            console.error("获取网站信息出错:", error);
          });

        // 显示对话框
        document.getElementById("editLinkModal").style.display = "flex";
      }
    });

    // 关闭对话框
    document
      .getElementById("closeModal")
      .addEventListener("click", function () {
        document.getElementById("editLinkModal").style.display = "none";
      });

    document
      .getElementById("cancelEdit")
      .addEventListener("click", function () {
        document.getElementById("editLinkModal").style.display = "none";
      });

    // 点击遮罩层关闭对话框
    document
      .getElementById("editLinkModal")
      .addEventListener("click", function (e) {
        if (e.target === this) {
          this.style.display = "none";
        }
      });

    // 处理表单提交
    document
      .getElementById("editLinkForm")
      .addEventListener("submit", function (e) {
        e.preventDefault();

        const siteId = document.getElementById("editLinkId").value;
        const title = document.getElementById("editTitle").value;
        const url = document.getElementById("editUrl").value;
        const icon = document.getElementById("editIcon").value;
        const description = document.getElementById("editDescription").value;

        // 发送修改请求到服务器
        fetch(`/api/website/${siteId}/update`, {
          method: "POST",
          headers: {
            "Content-Type": "application/json",
          },
          body: JSON.stringify({
            title: title,
            url: url,
            icon: icon,
            description: description,
          }),
        })
          .then((response) => response.json())
          .then((data) => {
            if (data.success) {
              // 关闭对话框
              document.getElementById("editLinkModal").style.display = "none";

              // 更新卡片显示
              if (currentCard) {
                const titleEl = currentCard.querySelector(".site-title");
                const descEl = currentCard.querySelector(".site-description");
                const iconImg = currentCard.querySelector(".site-icon img");
                const iconContainer = currentCard.querySelector(".site-icon");

                if (titleEl) titleEl.textContent = title;
                if (descEl) descEl.textContent = description;

                // 更新图标
                if (icon) {
                  if (iconImg) {
                    iconImg.src = icon;
                  } else {
                    // 如果之前没有图标，创建一个
                    iconContainer.innerHTML = `<img src="${icon}" alt="${title}">`;
                  }
                } else if (iconImg) {
                  // 如果清除了图标，显示默认图标
                  iconContainer.innerHTML = '<i class="bi bi-globe text-primary"></i>';
                }
              }

              alert("网站信息修改成功!");

              // 刷新页面以确保所有内容都是最新的
              setTimeout(() => {
                window.location.reload();
              }, 1000);
            } else {
              alert("修改失败: " + data.message);
            }
          })
          .catch((error) => {
            console.error("修改链接出错:", error);
            alert("修改链接时发生错误，请重试");
          });
      });

    // 访问链接按钮点击事件
    visitLinkBtn.addEventListener("click", function () {
      if (currentCard) {
        // 先隐藏上下文菜单
        contextMenu.style.display = "none";
        // 在新标签页中打开链接
        window.open(currentCard.href, "_blank");
      }
    });

    // 添加收藏按钮点击事件
    if (addFavoriteBtn) {
      addFavoriteBtn.addEventListener("click", function () {
        if (currentCard) {
          // 隐藏上下文菜单
          contextMenu.style.display = "none";

          const cardId = currentCard.href.split("/").pop();
          const cardTitle = currentCard.querySelector(".site-title").textContent;

          // 发送添加收藏的请求
          fetch(`/api/favorite/add/${cardId}`, {
            method: "POST",
            headers: {
              "Content-Type": "application/json",
            }
          })
            .then(response => response.json())
            .then(data => {
              if (data.success) {
                alert(`已将"${cardTitle}"添加到收藏!`);
              } else {
                alert(data.message || "添加收藏失败，请重试");
              }
            })
            .catch(error => {
              console.error("添加收藏出错:", error);
              alert("添加收藏时发生错误，请重试");
            });
        }
      });
    }

    // 分享按钮点击事件
    if (shareSiteBtn) {
      shareSiteBtn.addEventListener("click", function () {
        if (currentCard) {
          // 隐藏上下文菜单
          contextMenu.style.display = "none";

          const cardId = currentCard.href.split("/").pop();
          const cardTitle = currentCard.querySelector(".site-title").textContent;

          // 创建分享链接
          const shareUrl = `${window.location.origin}/site/${cardId}`;

          // 如果支持原生分享API
          if (navigator.share) {
            navigator.share({
              title: cardTitle,
              url: shareUrl
            })
              .catch(error => console.error("分享失败:", error));
          } else {
            // 否则复制链接到剪贴板
            const textArea = document.createElement("textarea");
            textArea.value = shareUrl;
            document.body.appendChild(textArea);
            textArea.select();
            document.execCommand("copy");
            document.body.removeChild(textArea);

            alert("链接已复制到剪贴板");
          }
        }
      });
    }

    // 删除链接按钮点击事件
    const deleteLinkBtn = document.getElementById("deleteLink");
    if (deleteLinkBtn) {
      deleteLinkBtn.addEventListener("click", function() {
        if (currentCard) {
          // 隐藏上下文菜单
          contextMenu.style.display = "none";

          const cardId = currentCard.href.split("/").pop();
          const cardTitle = currentCard.querySelector(".site-title").textContent;

          // 弹出确认对话框
          if (confirm(`确定要删除"${cardTitle}"吗？此操作不可恢复。`)) {
            // 发送删除请求
            fetch(`/api/website/delete/${cardId}`, {
              method: "DELETE",
              headers: {
                "Content-Type": "application/json",
              }
            })
              .then(response => response.json())
              .then(data => {
                if (data.success) {
                  alert(data.message);

                  // 从DOM中移除已删除的卡片
                  currentCard.remove();
                  currentCard = null;
                } else {
                  alert("删除失败: " + (data.message || "未知错误"));
                }
              })
              .catch(error => {
                console.error("删除链接出错:", error);
                alert("删除链接时发生错误，请重试");
              });
          }
        }
      });
    }

    // 自动获取网站信息
    document.getElementById("fetchInfo").addEventListener("click", function() {
      const urlInput = document.getElementById("editUrl");
      const titleInput = document.getElementById("editTitle");
      const descInput = document.getElementById("editDescription");
      const iconInput = document.getElementById("editIcon");
      const url = urlInput.value.trim();

      if (!url) {
        alert("请先输入网站链接地址");
        return;
      }

      // 显示加载状态
      this.classList.add("loading");

      // 请求网站信息
      fetch(`/api/fetch_website_info?url=${encodeURIComponent(url)}`)
        .then(response => response.json())
        .then(data => {
          if (data.success) {
            // 如果当前标题或描述为空，自动填充
            if (data.title && !titleInput.value.trim()) {
              titleInput.value = data.title;
            }

            if (data.description && !descInput.value.trim()) {
              descInput.value = data.description;
            }

            // 解析域名获取图标
            if (!iconInput.value.trim()) {
              try {
                let domain = url;
                if (url.startsWith("http")) {
                  const urlObj = new URL(url);
                  domain = urlObj.hostname;
                } else if (url.includes("/")) {
                  domain = url.split("/")[0];
                }

                // 检查图标是否可用
                const testImg = new Image();
                testImg.onload = function() {
                  if (testImg.width < 8 || testImg.height < 8) {
                    // 如果图标太小，使用备用图标（使用Google的favicon服务）
                    iconInput.value = `https://www.google.com/s2/favicons?domain=${domain}&sz=64`;
                  } else {
                    iconInput.value = `https://favicon.cccyun.cc/${domain}`;
                  }
                };
                testImg.onerror = function() {
                  // 如果图标加载失败，使用备用图标
                  iconInput.value = `https://www.google.com/s2/favicons?domain=${domain}&sz=64`;
                };
                testImg.src = `https://favicon.cccyun.cc/${domain}`;

                // 默认先填入，如果有错误会被上面的回调更新
                iconInput.value = `https://favicon.cccyun.cc/${domain}`;
              } catch (error) {
                console.error("解析域名出错:", error);
              }
            }

            alert("网站信息获取成功！");
          } else {
            alert("获取网站信息失败: " + (data.message || "未知错误"));
          }
        })
        .catch(error => {
          console.error("获取网站信息出错:", error);
          alert("获取网站信息失败，请手动填写");
        })
        .finally(() => {
          // 移除加载状态
          this.classList.remove("loading");
        });
    });

    console.log("侧边栏脚本已加载");

    {% if current_user.is_authenticated and current_user.is_admin %}
    // 拖拽排序相关代码
    const cardContainers = document.querySelectorAll('.card-container.draggable');
    console.log("找到拖拽容器:", cardContainers.length);

    cardContainers.forEach(container => {
      enableDragSort(container);

      // 显示一次拖拽说明
      setTimeout(() => {
        const categoryId = container.dataset.categoryId;
        const instructions = document.getElementById(`dragInstructions-${categoryId}`);
        if (instructions) {
          instructions.classList.add('active');
          setTimeout(() => {
            instructions.classList.remove('active');
          }, 5000);
        }
      }, 1000);
    });

    // 拖拽状态
    let dragStartTime = 0;
    let longPressTimer;
    let draggedCard = null;

    function enableDragSort(container) {
      const cards = container.querySelectorAll(".site-card.draggable");
      console.log(`容器 ${container.dataset.categoryId} 中有 ${cards.length} 个可拖拽卡片`);

      cards.forEach((card, index) => {
        // 长按开始拖拽
        card.addEventListener("mousedown", handleMouseDown);
        card.addEventListener("touchstart", handleTouchStart, { passive: false });

        function handleMouseDown(e) {
          // 只响应左键点击
          if (e.button !== 0) return;

          e.preventDefault();
          startLongPress(card, e.clientX, e.clientY);
        }

        function handleTouchStart(e) {
          e.preventDefault(); // 阻止触摸时的默认行为
          const touch = e.touches[0];
          startLongPress(card, touch.clientX, touch.clientY);
        }

        // 拖动句柄点击直接激活拖拽
        const dragHandle = card.querySelector(".drag-handle");
        if (dragHandle) {
          dragHandle.addEventListener("mousedown", function(e) {
            e.stopPropagation(); // 阻止冒泡
            e.preventDefault();
            console.log("通过拖拽句柄开始拖拽");
            startDragging(card, container, e.clientX, e.clientY);
          });

          dragHandle.addEventListener("touchstart", function(e) {
            e.stopPropagation();
            e.preventDefault();
            const touch = e.touches[0];
            console.log("通过拖拽句柄开始触摸拖拽");
            startDragging(card, container, touch.clientX, touch.clientY);
          }, { passive: false });
        }
      });
    }

    function startLongPress(card, x, y) {
      console.log("开始长按", card.dataset.id);
      dragStartTime = Date.now();
      const initialX = x;
      const initialY = y;

      clearTimeout(longPressTimer);
      longPressTimer = setTimeout(() => {
        console.log("长按时间到，开始拖拽");
        startDragging(card, card.parentNode, initialX, initialY);
      }, 300); // 长按300ms激活拖拽

      // 监听鼠标抬起和移出
      document.addEventListener("mouseup", cancelLongPress);
      document.addEventListener("mouseleave", cancelLongPress);
      document.addEventListener("touchend", cancelLongPress);
      document.addEventListener("touchcancel", cancelLongPress);

      function cancelLongPress() {
        console.log("取消长按");
        clearTimeout(longPressTimer);
        document.removeEventListener("mouseup", cancelLongPress);
        document.removeEventListener("mouseleave", cancelLongPress);
        document.removeEventListener("touchend", cancelLongPress);
        document.removeEventListener("touchcancel", cancelLongPress);
      }
    }

    function startDragging(card, container, initialX, initialY) {
      if (draggedCard) {
        console.log("已有卡片正在拖拽中，忽略");
        return;
      }

      console.log("开始拖拽:", card.dataset.id);
      draggedCard = card;
      draggedCard.classList.add("dragging");

      // 创建卡片克隆作为拖拽时的视觉提示
      const rect = card.getBoundingClientRect();

      // 设置卡片初始位置
      draggedCard.style.position = "fixed";
      draggedCard.style.zIndex = "1000";
      draggedCard.style.left = rect.left + "px";
      draggedCard.style.top = rect.top + "px";
      draggedCard.style.width = rect.width + "px";
      draggedCard.style.height = rect.height + "px";

      // 禁用卡片的点击链接功能
      draggedCard.originalHref = draggedCard.getAttribute('href');
      draggedCard.removeAttribute('href');

      // 移动到鼠标/触摸位置
      moveAt(initialX, initialY);

      // 监听移动事件
      document.addEventListener('mousemove', onMouseMove);
      document.addEventListener('touchmove', onTouchMove, { passive: false });

      // 监听释放事件
      document.addEventListener('mouseup', onMouseUp);
      document.addEventListener('touchend', onMouseUp);

      function onMouseMove(e) {
        moveAt(e.clientX, e.clientY);
      }

      function onTouchMove(e) {
        e.preventDefault();
        const touch = e.touches[0];
        moveAt(touch.clientX, touch.clientY);
      }

      function moveAt(x, y) {
        if (!draggedCard) return;

        // 移动被拖拽的卡片
        draggedCard.style.left = x - draggedCard.offsetWidth / 2 + "px";
        draggedCard.style.top = y - draggedCard.offsetHeight / 2 + "px";

        const elemBelow = getElementBelow(x, y);

        if (elemBelow && elemBelow !== draggedCard) {
          // 执行卡片排序
          const rect = elemBelow.getBoundingClientRect();
          const middleY = rect.y + rect.height / 2;

          if (y < middleY && elemBelow.previousElementSibling !== draggedCard) {
            elemBelow.parentNode.insertBefore(draggedCard, elemBelow);
          } else if (y >= middleY && elemBelow.nextElementSibling !== draggedCard) {
            elemBelow.parentNode.insertBefore(draggedCard, elemBelow.nextElementSibling);
          }
        }
      }

      function onMouseUp() {
        console.log("拖拽结束");
        document.removeEventListener('mousemove', onMouseMove);
        document.removeEventListener('touchmove', onTouchMove);
        document.removeEventListener('mouseup', onMouseUp);
        document.removeEventListener('touchend', onMouseUp);

        if (!draggedCard) return;

        // 停止拖拽
        draggedCard.classList.remove("dragging");
        draggedCard.style.position = "";
        draggedCard.style.zIndex = "";
        draggedCard.style.left = "";
        draggedCard.style.top = "";
        draggedCard.style.width = "";
        draggedCard.style.height = "";

        // 恢复链接功能
        if (draggedCard.originalHref) {
          draggedCard.setAttribute('href', draggedCard.originalHref);
          draggedCard.originalHref = null;
        }

        // 更新排序并发送到服务器
        updateSortOrder(container);

        // 重置拖拽状态
        draggedCard = null;
      }
    }

    function getElementBelow(x, y) {
      if (!draggedCard) return null;

      // 临时隐藏当前拖拽的元素，以便获取下面的元素
      const originalDisplay = draggedCard.style.display;
      draggedCard.style.display = "none";

      // 获取指定位置的元素
      let elemBelow = document.elementFromPoint(x, y);

      // 恢复拖拽元素的显示
      draggedCard.style.display = originalDisplay;

      // 查找最近的.site-card元素
      if (elemBelow) {
        return elemBelow.closest(".site-card");
      }

      return null;
    }

    function updateSortOrder(container) {
      const cards = container.querySelectorAll(".site-card");
      if (!cards.length) {
        console.log("没有找到卡片，不更新排序");
        return;
      }

      const categoryId = container.dataset.categoryId;
      const items = [];

      // 按新顺序重新分配权重
      cards.forEach((card, index) => {
        const websiteId = parseInt(card.dataset.id);
        if (isNaN(websiteId)) {
          console.error("卡片ID无效:", card.dataset.id);
          return;
        }

        const newSortOrder = index * 10; // 每10个单位，方便将来插入

        // 修改data-sort属性
        card.dataset.sort = newSortOrder;

        items.push({
          id: websiteId,
          sort_order: newSortOrder
        });
      });

      console.log("更新排序 (仅前端模拟):", items);

      // 前端模拟成功响应，暂时不发送到服务器
      /* 数据库迁移完成后取消注释
      fetch('/api/website/update_order', {
        method: 'POST',
        headers: {
          'Content-Type': 'application/json'
        },
        body: JSON.stringify({
          category_id: categoryId,
          items: items
        })
      })
      .then(response => response.json())
      .then(data => {
        if (data.success) {
          console.log("排序保存成功");
        } else {
          console.error('保存排序失败:', data.message);
        }
      })
      .catch(error => {
        console.error('保存排序出错:', error);
      });
      */
    }
    {% endif %}
  });
</script>
{% endblock %}
