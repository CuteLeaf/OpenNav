{% extends "base.html" %} {# 定义图标渲染宏 #} {% macro
render_icon(icon_name='folder', color='#3498db') %}
<i
  class="bi bi-{{ icon_name }}"
  {%
  if
  color
  %}style="color: {{ color }}"
  {%
  endif
  %}
></i>
{% endmacro %} {% block head %}
<link rel="preconnect" href="https://fonts.googleapis.com" />
<link rel="preconnect" href="https://fonts.gstatic.com" crossorigin />
<link
  href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500&family=Poppins:wght@500;600&display=swap"
  rel="stylesheet"
/>
<link
  rel="stylesheet"
  href="{{ url_for('static', filename='css/variables.css') }}"
/>
<link
  rel="stylesheet"
  href="{{ url_for('static', filename='css/layout.css') }}"
/>
<link
  rel="stylesheet"
  href="{{ url_for('static', filename='css/navbar.css') }}"
/>
<link
  rel="stylesheet"
  href="{{ url_for('static', filename='css/sidebar.css') }}"
/>
<link
  rel="stylesheet"
  href="{{ url_for('static', filename='css/card.css') }}"
/>
<link
  rel="stylesheet"
  href="{{ url_for('static', filename='css/search.css') }}"
/>
<link
  rel="stylesheet"
  href="{{ url_for('static', filename='css/modal.css') }}"
/>
<link
  rel="stylesheet"
  href="{{ url_for('static', filename='css/contextMenu.css') }}"
/>
<style>
  /* 添加自定义tooltip样式 */
  .custom-tooltip {
    position: fixed; /* 使用fixed定位确保滚动时跟随 */
    z-index: 9999;
    display: none;
    padding: 10px 15px;
    background-color: rgba(0, 0, 0, 0.8);
    color: white;
    border-radius: 4px;
    min-width: 100px;
    max-width: 300px;
    width: auto;
    box-shadow: 0 2px 10px rgba(0, 0, 0, 0.2);
    font-size: 14px;
    line-height: 1.5;
    pointer-events: none;
    transition: opacity 0.2s;
    white-space: normal;
  }

  /* 添加统一的箭头样式 */
  .custom-tooltip::after {
    content: "";
    position: absolute;
    width: 0;
    height: 0;
    border-left: 8px solid transparent;
    border-right: 8px solid transparent;
    border-top: 8px solid rgba(0, 0, 0, 0.8);
    bottom: -8px;
    left: 50%;
    margin-left: -8px;
  }

  /* 当tooltip显示在卡片下方时的箭头 */
  .custom-tooltip.bottom-arrow::after {
    border-top: none;
    border-bottom: 8px solid rgba(0, 0, 0, 0.8);
    top: -8px;
    bottom: auto;
  }

  /* 添加多行显示样式 */
  .custom-tooltip.multiline {
    width: 300px;
  }
</style>
{% endblock %} {% block content %} {# 顶部导航栏 #}
<div class="top-navbar">
  <div class="menu-toggle" id="menuToggle">
    <i class="bi bi-list"></i>
  </div>
  <a href="{{ url_for('main.index') }}" class="navbar-logo">
    <i class="bi bi-collection me-2"></i> 炫酷导航
  </a>
</div>

{# 遮罩层 #}
<div class="sidebar-overlay" id="sidebarOverlay"></div>

{# 侧边栏 #}
<div class="sidebar" id="sidebar">
  <div class="sidebar-content">
    {# 分类菜单 #}
    <div class="sidebar-group">
      <div class="sidebar-group-title">网站分类</div>
      <ul class="sidebar-menu">
        {% for category in categories %}
        <li class="sidebar-menu-item">
          <a href="#{{ category.name }}" class="sidebar-menu-link">
            <span class="sidebar-menu-icon">
              {{ render_icon(category.icon or 'folder', category.color or
              '#3498db') }}
            </span>
            {{ category.name }}
          </a>
        </li>
        {% endfor %}
      </ul>
    </div>

    {# 更多菜单 #}
    <div class="sidebar-group">
      <div class="sidebar-group-title">更多</div>
      <ul class="sidebar-menu">
        <li class="sidebar-menu-item">
          <a href="{{ url_for('main.about') }}" class="sidebar-menu-link">
            <span class="sidebar-menu-icon"
              >{{ render_icon('info-circle') }}</span
            >
            关于本站
          </a>
        </li>

        {% if current_user.is_authenticated %}
        <li class="sidebar-menu-item">
          <a href="{{ url_for('auth.logout') }}" class="sidebar-menu-link">
            <span class="sidebar-menu-icon"
              >{{ render_icon('box-arrow-right') }}</span
            >
            退出登录
          </a>
        </li>
        {% if current_user.is_admin %}
        <li class="sidebar-menu-item">
          <a href="{{ url_for('admin.index') }}" class="sidebar-menu-link">
            <span class="sidebar-menu-icon"
              >{{ render_icon('speedometer2') }}</span
            >
            管理面板
          </a>
        </li>
        {% endif %} {% else %}
        <li class="sidebar-menu-item">
          <a href="{{ url_for('auth.login') }}" class="sidebar-menu-link">
            <span class="sidebar-menu-icon"
              >{{ render_icon('box-arrow-in-right') }}</span
            >
            登录
          </a>
        </li>
        <li class="sidebar-menu-item">
          <a href="{{ url_for('auth.register') }}" class="sidebar-menu-link">
            <span class="sidebar-menu-icon"
              >{{ render_icon('person-plus') }}</span
            >
            注册
          </a>
        </li>
        {% endif %}
      </ul>
    </div>
  </div>
</div>

{# 主内容区域 #}
<div class="main-content" id="mainContent">
  {# 搜索区域 #}
  <div class="main-search-container mb-4">
    <form id="searchForm" class="main-search-form">
      <div class="search-input-group">
        <input
          type="search"
          name="q"
          id="searchInput"
          class="main-search-input"
          placeholder="请输入关键字搜索网站"
          autocomplete="off"
        />
        <button type="submit" class="main-search-button">
          <i class="bi bi-search"></i>
        </button>
        <button
          type="button"
          id="clearSearch"
          class="search-clear-button"
          style="display: none"
        >
          <i class="bi bi-x"></i>
        </button>
      </div>
    </form>
  </div>

  {# 搜索结果区域 #}
  <div id="searchResults" class="mb-5" style="display: none">
    <div id="resultsContainer">
      <h3 class="category-heading">
        <span class="category-icon">
          <i class="bi bi-search"></i>
        </span>
        搜索结果 <span id="searchKeyword" class="search-keyword"></span>
      </h3>
      <div id="resultsContent">{# 搜索结果将通过JavaScript动态填充 #}</div>
      <div
        id="noResults"
        class="text-center text-muted py-4"
        style="display: none"
      >
        <i class="bi bi-emoji-frown fs-4"></i>
        <p>未找到相关网站</p>
        <p class="text-muted">您可以尝试使用其他关键词，或浏览现有分类</p>
      </div>
    </div>
  </div>

  {# 分类内容区域 #}
  <div id="categoriesContainer">
    {% for category in categories %}
    <div id="{{ category.name }}" class="mb-5">
      <h3 class="category-heading">
        <span
          class="category-icon"
          style="background-color: {{ category.color or '#3498db' }}"
        >
          <i class="bi bi-{{ category.icon or 'folder' }}"></i>
        </span>
        {{ category.name }}
      </h3>

      {% set websites = category.website_list %} {% if websites %}
      <div
        class="card-container {% if current_user.is_authenticated and current_user.is_admin %}draggable{% endif %}"
        data-category-id="{{ category.id }}"
      >
        {% for website in websites[:category.display_limit] %}
        <a
          href="{{ url_for('main.site', id=website.id) }}"
          class="site-card {% if current_user.is_authenticated and current_user.is_admin %}draggable{% endif %}"
          data-id="{{ website.id }}"
          data-sort="{{ website.sort_order|default(loop.index0*10) }}"
          title="{{ website.description }}"
          data-bs-toggle="tooltip"
          data-bs-title="{{ website.description }}"
        >
          {% if website.is_private %}
          <div class="private-badge" title="私有链接">
            <i class="bi bi-lock-fill"></i>
          </div>
          {% endif %}
          <div class="site-header">
            <div class="site-icon">
              {% if website.icon %}
              <img src="{{ website.icon }}" alt="{{ website.title }}" />
              {% else %}
              <i class="bi bi-globe text-primary"></i>
              {% endif %}
            </div>
            <div class="site-text">
              <h5 class="site-title">{{ website.title }}</h5>
              <p class="site-description">
                {{ website.description|truncate(60) }}
              </p>
            </div>
          </div>
        </a>
        {% endfor %}
      </div>

      {% if websites|length > (category.display_limit or 8) %}
      <div class="text-center mt-3">
        <a
          href="{{ url_for('main.category', id=category.id) }}"
          class="btn btn-sm btn-outline-primary"
        >
          查看全部 ({{ websites|length }})
        </a>
      </div>
      {% endif %} {% else %}
      <div class="text-center text-muted py-4">
        <i class="bi bi-emoji-neutral fs-4"></i>
        <p>暂无网站</p>
      </div>
      {% endif %}
    </div>
    {% else %}
    <div class="text-center py-5">
      <div class="display-6 text-muted">
        <i class="bi bi-emoji-dizzy fs-1"></i>
        <p>暂无分类，请管理员添加</p>
      </div>
    </div>
    {% endfor %}
  </div>

  {# 快速添加链接对话框 #} {% if current_user.is_authenticated and
  current_user.is_admin %}
  <div id="quickAddModal" class="modal">
    <div class="modal-content">
      <div class="modal-header">
        <h5>快速添加链接</h5>
        <button
          type="button"
          class="btn-close"
          onclick="closeQuickAddModal()"
        ></button>
      </div>
      <div class="modal-body">
        <div class="mb-3">
          <label class="form-label">网站标题</label>
          <input type="text" id="quickAddTitle" class="form-control" />
        </div>
        <div class="mb-3">
          <label class="form-label">网站链接</label>
          <input type="text" id="quickAddUrl" class="form-control" />
        </div>
        <div class="mb-3">
          <label class="form-label">网站图标</label>
          <div class="d-flex align-items-center">
            <img
              id="quickAddIconPreview"
              src=""
              alt=""
              style="
                width: 24px;
                height: 24px;
                margin-right: 10px;
                display: none;
              "
            />
            <input type="text" id="quickAddIcon" class="form-control" />
          </div>
        </div>
        <div class="mb-3">
          <label class="form-label">网站描述</label>
          <textarea
            id="quickAddDescription"
            class="form-control"
            rows="3"
          ></textarea>
        </div>
        <div class="mb-3">
          <label class="form-label">访问权限</label>
          <div class="d-flex gap-3">
            <div class="form-check">
              <input
                class="form-check-input"
                type="radio"
                name="quickAddPrivacy"
                id="quickAddPublic"
                value="0"
                checked
              />
              <label class="form-check-label" for="quickAddPublic">
                <i class="bi bi-globe"></i> 公开
              </label>
            </div>
            <div class="form-check">
              <input
                class="form-check-input"
                type="radio"
                name="quickAddPrivacy"
                id="quickAddPrivate"
                value="1"
              />
              <label class="form-check-label" for="quickAddPrivate">
                <i class="bi bi-lock"></i> 私有
              </label>
            </div>
          </div>
        </div>
        <div class="mb-3">
          <label class="form-label"
            >所属分类 <span class="text-danger">*</span></label
          >
          <select id="quickAddCategory" class="form-select" required>
            <option value="">请选择分类</option>
            {% for category in categories %}
            <option value="{{ category.id }}">{{ category.name }}</option>
            {% endfor %}
          </select>
        </div>
      </div>
      <div class="modal-footer">
        <button
          type="button"
          class="btn btn-secondary"
          onclick="closeQuickAddModal()"
        >
          取消
        </button>
        <button
          type="button"
          class="btn btn-primary"
          onclick="submitQuickAdd()"
        >
          添加
        </button>
      </div>
    </div>
  </div>
  {% endif %}
</div>

{# 卡片右键菜单 #}
<div id="contextMenu" class="context-menu" style="display: none">
  <div class="context-menu-item" id="visitLink">
    <i class="bi bi-box-arrow-up-right"></i> 访问链接
  </div>
  {% if current_user.is_authenticated %} {% if current_user.is_admin %}
  <div class="context-menu-item" id="editLink">
    <i class="bi bi-pencil"></i> 修改链接
  </div>
  <div class="context-menu-item" id="addLink">
    <i class="bi bi-plus-circle"></i> 添加链接
  </div>
  <div class="context-menu-item" id="deleteLink">
    <i class="bi bi-trash"></i> 删除链接
  </div>
  {% endif %}
  <div class="context-menu-item" id="shareSite">
    <i class="bi bi-share"></i> 分享
  </div>
  {% endif %}
</div>

{# 修改链接对话框 #}
<div class="modal-overlay" id="editLinkModal" style="display: none">
  <div class="edit-modal">
    <div class="modal-header">
      <h4>修改链接</h4>
      <button class="modal-close" id="closeModal">
        <i class="bi bi-x"></i>
      </button>
    </div>
    <div class="modal-body">
      <form id="editLinkForm">
        <div class="form-group">
          <label for="editTitle">标题</label>
          <input type="text" id="editTitle" class="modal-input" required />
        </div>
        <div class="form-group">
          <label for="editUrl">链接地址</label>
          <div class="url-input-group">
            <input type="url" id="editUrl" class="modal-input" required />
            <button
              type="button"
              id="fetchInfo"
              class="icon-fetch-btn"
              title="获取网站信息"
            >
              <i class="bi bi-cloud-download"></i>
            </button>
          </div>
        </div>
        <div class="form-group">
          <label for="editIcon">图标地址</label>
          <input
            type="url"
            id="editIcon"
            class="modal-input"
            placeholder="输入图标URL或留空使用默认图标"
          />
        </div>
        <div class="form-group">
          <label for="editDescription">描述</label>
          <textarea
            id="editDescription"
            class="modal-input"
            rows="5"
          ></textarea>
        </div>
        <div class="form-group">
          <label>访问权限</label>
          <div class="d-flex gap-3">
            <div class="form-check">
              <input
                class="form-check-input"
                type="radio"
                name="editPrivacy"
                id="editPublic"
                value="0"
                checked
              />
              <label class="form-check-label" for="editPublic">
                <i class="bi bi-globe"></i> 公开
              </label>
            </div>
            <div class="form-check">
              <input
                class="form-check-input"
                type="radio"
                name="editPrivacy"
                id="editPrivate"
                value="1"
              />
              <label class="form-check-label" for="editPrivate">
                <i class="bi bi-lock"></i> 私有
              </label>
            </div>
          </div>
        </div>
        <input type="hidden" id="editLinkId" />
        <div class="modal-actions">
          <button type="button" class="modal-btn cancel" id="cancelEdit">
            取消
          </button>
          <button type="submit" class="modal-btn save">保存</button>
        </div>
      </form>
    </div>
  </div>
</div>
{% endblock %} {% block scripts %}
<script src="{{ url_for('static', filename='js/index.js') }}"></script>
<script src="{{ url_for('static', filename='js/sidebar.js') }}"></script>
<script src="{{ url_for('static', filename='js/search.js') }}"></script>
<script src="{{ url_for('static', filename='js/modal.js') }}"></script>
<script src="{{ url_for('static', filename='js/contextMenu.js') }}"></script>
{% if current_user.is_authenticated and current_user.is_admin %}
<script src="{{ url_for('static', filename='js/dragSort.js') }}"></script>
<script src="{{ url_for('static', filename='js/quickAdd.js') }}"></script>
{% endif %}

<script>
  document.addEventListener("DOMContentLoaded", function () {
    // 移除可能存在的旧tooltip
    const oldTooltips = document.querySelectorAll(".custom-tooltip");
    oldTooltips.forEach((tooltip) => tooltip.remove());

    // 创建单个全局tooltip元素
    const tooltip = document.createElement("div");
    tooltip.classList.add("custom-tooltip");
    document.body.appendChild(tooltip);

    // 全局变量跟踪上次显示的卡片
    let lastDisplayedCard = null;

    // 获取所有网站卡片
    const siteCards = document.querySelectorAll(".site-card");

    // 存储当前激活的卡片
    let activeCard = null;

    // 为图标添加错误处理
    document.querySelectorAll(".site-icon img").forEach((img) => {
      img.onerror = function () {
        this.style.display = "none";
        const icon = document.createElement("i");
        icon.className = "bi bi-globe text-primary";
        this.parentNode.appendChild(icon);
      };
    });

    // 更新tooltip位置
    function updateTooltipPosition(card) {
      const description = card.getAttribute("data-description");
      if (!description) return;

      // 获取卡片位置
      const cardRect = card.getBoundingClientRect();

      // 设置tooltip内容
      tooltip.textContent = description;

      // 判断是否需要多行显示
      if (description.length > 50) {
        tooltip.classList.add("multiline");
        tooltip.style.width = "300px";
      } else {
        tooltip.classList.remove("multiline");

        // 确保隐藏状态并重置宽度进行测量
        const oldDisplay = tooltip.style.display;
        tooltip.style.display = "block";
        tooltip.style.visibility = "hidden";
        tooltip.style.width = "auto";

        // 获取实际宽度
        const tempWidth = tooltip.offsetWidth;
        const tooltipWidth = Math.max(Math.min(tempWidth, 300), 100);

        // 恢复原来的显示状态
        tooltip.style.visibility = "visible";
        tooltip.style.display = oldDisplay;

        // 设置宽度
        tooltip.style.width = tooltipWidth + "px";
      }

      // 检查下方空间是否足够
      const bottomSpace = window.innerHeight - cardRect.bottom;
      const tooltipHeight = tooltip.offsetHeight;

      // 计算tooltip的初始位置（水平居中对齐卡片）
      const tooltipWidth = tooltip.offsetWidth;
      let leftPos = cardRect.left + cardRect.width / 2 - tooltipWidth / 2;

      // 边界检查 - 水平方向
      if (leftPos < 10) {
        leftPos = 10;
      } else if (leftPos + tooltipWidth > window.innerWidth - 10) {
        leftPos = window.innerWidth - tooltipWidth - 10;
      }

      tooltip.style.left = leftPos + "px";

      // 优先显示在下方（除非空间不足）
      if (bottomSpace >= tooltipHeight + 15) {
        // 显示在下方，箭头指向上方
        tooltip.style.top = cardRect.bottom + 10 + "px";
        tooltip.classList.add("bottom-arrow");
      } else {
        // 下方空间不足，显示在上方，箭头指向下方
        tooltip.style.top = cardRect.top - tooltipHeight - 10 + "px";
        tooltip.classList.remove("bottom-arrow");

        // 检查上方空间是否足够，如果不够就再次调整
        if (cardRect.top < tooltipHeight + 15) {
          // 上下都不够空间，强制显示在下方并调整垂直位置
          tooltip.style.top = window.innerHeight - tooltipHeight - 10 + "px";
          tooltip.classList.add("bottom-arrow");
        }
      }
    }

    // 监听鼠标事件
    siteCards.forEach((card) => {
      const description = card.getAttribute("title");

      // 保存描述到自定义属性
      if (description && description.trim()) {
        card.setAttribute("data-description", description);
      }

      // 移除原始title以避免浏览器默认tooltip
      card.removeAttribute("title");
      card.removeAttribute("data-bs-toggle");
      card.removeAttribute("data-bs-title");

      if (description && description.trim()) {
        card.addEventListener("mouseenter", function (e) {
          // 重置之前的卡片
          if (lastDisplayedCard && lastDisplayedCard !== card) {
            tooltip.style.display = "none";
          }

          activeCard = card;
          lastDisplayedCard = card;
          tooltip.style.display = "block";
          updateTooltipPosition(card);
        });

        card.addEventListener("mouseleave", function () {
          tooltip.style.display = "none";
          activeCard = null;
        });
      }
    });

    // 监听滚动事件
    window.addEventListener("scroll", function () {
      if (activeCard) {
        updateTooltipPosition(activeCard);
      }
    });

    // 监听窗口大小变化
    window.addEventListener("resize", function () {
      if (activeCard) {
        updateTooltipPosition(activeCard);
      }
    });
  });
</script>
{% endblock %}
