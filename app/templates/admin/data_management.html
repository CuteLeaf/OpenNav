{% extends "admin/base.html" %} {% block admin_content %}
<div class="container-fluid px-4">
  <div class="d-flex justify-content-between align-items-center mb-4">
    <h1 class="mt-4">数据管理</h1>
  </div>

  <div class="row">
    <div class="col-lg-6">
      <!-- 数据导出卡片 -->
      <div class="card mb-4">
        <div class="card-header">
          <i class="bi bi-box-arrow-up"></i> 数据导出
        </div>
        <div class="card-body">
          <p class="mb-3">
            导出数据库可以备份所有网站链接和分类数据，导出的数据库兼容OneNav格式。
          </p>

          <div class="alert alert-info">
            <i class="bi bi-info-circle"></i>
            导出的数据库可以在其他OneNav系统或本系统中导入使用。
          </div>

          <a href="{{ url_for('admin.export_data') }}" class="btn btn-primary">
            <i class="bi bi-download"></i> 导出数据库
          </a>
        </div>
      </div>
    </div>

    <div class="col-lg-6">
      <!-- 数据导入卡片 -->
      <div class="card mb-4">
        <div class="card-header">
          <i class="bi bi-box-arrow-in-down"></i> 数据导入
        </div>
        <div class="card-body">
          <p class="mb-3">
            您可以导入本系统或OneNav格式的数据库。系统会自动检测数据库格式并进行转换。
          </p>

          <div class="alert alert-warning">
            <i class="bi bi-exclamation-triangle"></i>
            <strong>注意：</strong>
            使用替换模式会先备份当前数据库，然后清空现有数据后导入新数据。合并模式会保留现有数据并添加新数据（避免URL重复）。
          </div>

          <form
            method="post"
            action="{{ url_for('admin.import_data') }}"
            enctype="multipart/form-data"
            id="import-form"
          >
            {{ import_form.hidden_tag() }}

            <div class="mb-3">
              <label for="db_file" class="form-label">数据库文件</label>
              <input
                type="file"
                class="form-control"
                id="db_file"
                name="db_file"
                required
                accept=".db,.db3,.sqlite,.sqlite3"
              />
              <div class="form-text">支持.db、.db3、.sqlite、.sqlite3格式</div>
            </div>

            <div class="mb-3">
              <label for="import_type" class="form-label">导入类型</label>
              <select class="form-select" name="import_type" id="import_type">
                <option value="merge">合并 - 保留现有数据</option>
                <option value="replace">替换 - 清空现有数据</option>
              </select>
              <div class="form-text">
                替换模式会先备份数据库，然后清空所有现有数据后再导入
              </div>
            </div>

            <button type="submit" class="btn btn-success">
              <i class="bi bi-upload"></i> 开始导入
            </button>
          </form>
        </div>
      </div>
    </div>
  </div>

  <!-- 数据清理功能 -->
  <div class="card mb-4">
    <div class="card-header"><i class="bi bi-trash"></i> 数据清理</div>
    <div class="card-body">
      <div class="row">
        <div class="col-md-6">
          <div class="card h-100 bg-light">
            <div class="card-body">
              <h5 class="card-title">清空网站链接</h5>
              <p class="card-text">
                删除系统中的所有网站链接，但保留分类结构。此操作不可恢复。
              </p>

              <button
                type="button"
                class="btn btn-danger"
                data-bs-toggle="modal"
                data-bs-target="#clearLinksModal"
              >
                <i class="bi bi-trash"></i> 清空所有链接
              </button>
            </div>
          </div>
        </div>

        <div class="col-md-6">
          <div class="card h-100 bg-light">
            <div class="card-body">
              <h5 class="card-title">清空全部数据</h5>
              <p class="card-text">
                删除系统中的所有网站链接和分类数据。此操作不可恢复！
              </p>

              <button
                type="button"
                class="btn btn-danger"
                data-bs-toggle="modal"
                data-bs-target="#clearAllModal"
              >
                <i class="bi bi-exclamation-triangle"></i> 清空所有数据
              </button>
            </div>
          </div>
        </div>
      </div>
    </div>
  </div>

  <!-- 数据格式说明 -->
  <div class="card mb-4">
    <div class="card-header"><i class="bi bi-info-circle"></i> 兼容性说明</div>
    <div class="card-body">
      <h5>支持导入的数据库格式</h5>
      <ul>
        <li><strong>本系统格式</strong> - 直接导入本系统导出的数据库文件</li>
        <li>
          <strong>OneNav格式</strong> - 支持导入OneNav导航系统的数据库文件
        </li>
      </ul>

      <h5>OneNav兼容说明</h5>
      <p>系统会自动识别OneNav数据库格式并转换以下数据：</p>
      <ul>
        <li>分类（包括层级结构）</li>
        <li>链接数据（URL、标题、描述、图标等）</li>
        <li>排序权重</li>
        <li>私有状态</li>
        <li>点击量统计</li>
      </ul>

      <div class="alert alert-info">
        <i class="bi bi-lightbulb"></i>
        <strong>提示：</strong>
        导出的数据库同样可以导入到OneNav系统中，实现双向兼容。
      </div>
    </div>
  </div>
</div>

<!-- 清空链接确认模态框 -->
<div
  class="modal fade"
  id="clearLinksModal"
  tabindex="-1"
  aria-labelledby="clearLinksModalLabel"
  aria-hidden="true"
>
  <div class="modal-dialog">
    <div class="modal-content">
      <div class="modal-header">
        <h5 class="modal-title" id="clearLinksModalLabel">确认清空所有链接</h5>
        <button
          type="button"
          class="btn-close"
          data-bs-dismiss="modal"
          aria-label="Close"
        ></button>
      </div>
      <div class="modal-body">
        <div class="alert alert-danger">
          <i class="bi bi-exclamation-triangle"></i> <strong>警告：</strong>
          此操作将永久删除系统中的所有网站链接数据，但保留分类结构。此操作不可恢复！
        </div>
        <p>请输入"<strong>确认删除</strong>"以继续：</p>
        <input
          type="text"
          id="clearLinksConfirm"
          class="form-control"
          placeholder="确认删除"
        />
      </div>
      <div class="modal-footer">
        <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">
          取消
        </button>
        <button
          type="button"
          class="btn btn-danger"
          id="clearLinksBtn"
          disabled
        >
          确认清空
        </button>
      </div>
    </div>
  </div>
</div>

<!-- 清空所有数据确认模态框 -->
<div
  class="modal fade"
  id="clearAllModal"
  tabindex="-1"
  aria-labelledby="clearAllModalLabel"
  aria-hidden="true"
>
  <div class="modal-dialog">
    <div class="modal-content">
      <div class="modal-header">
        <h5 class="modal-title" id="clearAllModalLabel">确认清空所有数据</h5>
        <button
          type="button"
          class="btn-close"
          data-bs-dismiss="modal"
          aria-label="Close"
        ></button>
      </div>
      <div class="modal-body">
        <div class="alert alert-danger">
          <i class="bi bi-exclamation-triangle"></i> <strong>严重警告：</strong>
          此操作将永久删除系统中的所有网站链接和分类数据。此操作不可恢复！
        </div>
        <p>请输入"<strong>我确认清空所有数据</strong>"以继续：</p>
        <input
          type="text"
          id="clearAllConfirm"
          class="form-control"
          placeholder="我确认清空所有数据"
        />
      </div>
      <div class="modal-footer">
        <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">
          取消
        </button>
        <button type="button" class="btn btn-danger" id="clearAllBtn" disabled>
          确认清空所有数据
        </button>
      </div>
    </div>
  </div>
</div>
{% endblock %} {% block admin_scripts %}
<script>
  document.addEventListener("DOMContentLoaded", function () {
    // 文件上传验证
    const importForm = document.getElementById("import-form");
    const fileInput = document.getElementById("db_file");

    importForm.addEventListener("submit", function (e) {
      if (!fileInput.files || fileInput.files.length === 0) {
        e.preventDefault();
        alert("请选择要上传的数据库文件");
        return false;
      }

      const fileName = fileInput.files[0].name;
      const fileExt = fileName
        .substring(fileName.lastIndexOf("."))
        .toLowerCase();
      const validExtensions = [".db", ".db3", ".sqlite", ".sqlite3"];

      if (!validExtensions.includes(fileExt)) {
        e.preventDefault();
        alert("请选择有效的SQLite数据库文件 (.db, .db3, .sqlite, .sqlite3)");
        return false;
      }

      // 验证通过，显示加载状态
      const submitBtn = this.querySelector('button[type="submit"]');
      submitBtn.innerHTML =
        '<span class="spinner-border spinner-border-sm" role="status" aria-hidden="true"></span> 导入中...';
      submitBtn.disabled = true;

      return true;
    });

    // 文件选择预览
    fileInput.addEventListener("change", function () {
      if (this.files.length > 0) {
        const fileName = this.files[0].name;
        const fileExt = fileName
          .substring(fileName.lastIndexOf("."))
          .toLowerCase();
        const validExtensions = [".db", ".db3", ".sqlite", ".sqlite3"];

        if (!validExtensions.includes(fileExt)) {
          alert("请选择有效的SQLite数据库文件 (.db, .db3, .sqlite, .sqlite3)");
          this.value = ""; // 清空选择
        }
      }
    });

    // 清空链接确认
    const clearLinksConfirm = document.getElementById("clearLinksConfirm");
    const clearLinksBtn = document.getElementById("clearLinksBtn");

    clearLinksConfirm.addEventListener("input", function () {
      clearLinksBtn.disabled = this.value !== "确认删除";
    });

    clearLinksBtn.addEventListener("click", function () {
      // 显示加载状态
      this.innerHTML =
        '<span class="spinner-border spinner-border-sm" role="status" aria-hidden="true"></span> 正在处理...';
      this.disabled = true;

      // 发送清空请求
      fetch('{{ url_for("admin.clear_websites") }}', {
        method: "POST",
        headers: {
          "Content-Type": "application/json",
          "X-CSRFToken": document.querySelector('input[name="csrf_token"]')
            .value,
        },
      })
        .then((response) => response.json())
        .then((data) => {
          if (data.success) {
            // 关闭模态框
            const modal = bootstrap.Modal.getInstance(
              document.getElementById("clearLinksModal")
            );
            modal.hide();

            // 显示成功消息
            alert("成功清空所有链接数据！");
            location.reload();
          } else {
            alert("操作失败: " + data.message);
            this.innerHTML = "确认清空";
            this.disabled = false;
          }
        })
        .catch((error) => {
          alert("发生错误: " + error);
          this.innerHTML = "确认清空";
          this.disabled = false;
        });
    });

    // 清空所有数据确认
    const clearAllConfirm = document.getElementById("clearAllConfirm");
    const clearAllBtn = document.getElementById("clearAllBtn");

    clearAllConfirm.addEventListener("input", function () {
      clearAllBtn.disabled = this.value !== "我确认清空所有数据";
    });

    clearAllBtn.addEventListener("click", function () {
      // 显示加载状态
      this.innerHTML =
        '<span class="spinner-border spinner-border-sm" role="status" aria-hidden="true"></span> 正在处理...';
      this.disabled = true;

      // 发送清空请求
      fetch('{{ url_for("admin.clear_all_data") }}', {
        method: "POST",
        headers: {
          "Content-Type": "application/json",
          "X-CSRFToken": document.querySelector('input[name="csrf_token"]')
            .value,
        },
      })
        .then((response) => response.json())
        .then((data) => {
          if (data.success) {
            // 关闭模态框
            const modal = bootstrap.Modal.getInstance(
              document.getElementById("clearAllModal")
            );
            modal.hide();

            // 显示成功消息
            alert("成功清空所有数据！");
            location.reload();
          } else {
            alert("操作失败: " + data.message);
            this.innerHTML = "确认清空所有数据";
            this.disabled = false;
          }
        })
        .catch((error) => {
          alert("发生错误: " + error);
          this.innerHTML = "确认清空所有数据";
          this.disabled = false;
        });
    });
  });
</script>
{% endblock %}
