{% extends "admin/base.html" %} {% block admin_content %}
<div class="container-fluid px-4">
  <div class="d-flex justify-content-between align-items-center mb-3">
    <div>
      <h1 class="mt-4">站点设置</h1>
      <ol class="breadcrumb mb-2">
        <li class="breadcrumb-item">
          <a href="{{ url_for('admin.index') }}">首页</a>
        </li>
        <li class="breadcrumb-item active">站点设置</li>
      </ol>
    </div>
  </div>

  <div class="card mb-4">
    <div class="card-header bg-primary text-white">
      <i class="bi bi-gear me-1"></i>
      站点基本设置
    </div>
    <div class="card-body">
      <form method="post" enctype="multipart/form-data">
        {{ form.hidden_tag() }}

        <div class="row mb-4">
          <div class="col-md-6">
            <div class="mb-3">
              {{ form.site_name.label(class="form-label fw-bold") }} {{
              form.site_name(class="form-control") }} {% if
              form.site_name.errors %} {% for error in form.site_name.errors %}
              <div class="text-danger">{{ error }}</div>
              {% endfor %} {% endif %}
              <div class="form-text">网站标题将显示在浏览器标签和导航栏</div>
            </div>

            <div class="mb-3">
              {{ form.site_subtitle.label(class="form-label fw-bold") }} {{
              form.site_subtitle(class="form-control") }}
              <div class="form-text">副标题可显示在网站首页或页脚</div>
            </div>
          </div>

          <div class="col-md-6">
            <div class="mb-3">
              {{ form.site_keywords.label(class="form-label fw-bold") }} {{
              form.site_keywords(class="form-control") }}
              <div class="form-text">用于SEO，多个关键词之间用英文逗号分隔</div>
            </div>

            <div class="mb-3">
              {{ form.site_description.label(class="form-label fw-bold") }} {{
              form.site_description(class="form-control", rows=3) }}
              <div class="form-text">网站描述用于SEO和社交媒体分享</div>
            </div>
          </div>
        </div>

        <hr class="my-4" />

        <div class="row mb-4">
          <div class="col-md-6">
            <div class="mb-3">
              <label class="form-label fw-bold">网站Logo</label>
              <div class="d-flex align-items-center mb-2">
                <div class="site-logo-preview me-3">
                  {% if settings.site_logo %}
                  <img
                    src="{{ settings.site_logo }}"
                    alt="网站Logo"
                    style="max-height: 50px"
                  />
                  {% else %}
                  <div class="text-center p-3 bg-light rounded">
                    <i class="bi bi-collection"></i> 默认Logo
                  </div>
                  {% endif %}
                </div>
              </div>
              <div class="input-group mb-2">
                <span class="input-group-text"
                  ><i class="bi bi-link-45deg"></i
                ></span>
                {{ form.site_logo(class="form-control", placeholder="Logo URL")
                }}
              </div>
              <div class="form-text mb-2">外部图床URL或相对路径</div>
              <div class="input-group">
                <span class="input-group-text"
                  ><i class="bi bi-upload"></i
                ></span>
                {{ form.logo_file(class="form-control") }}
              </div>
              <div class="form-text">或直接上传图片（优先使用上传）</div>
            </div>
          </div>

          <div class="col-md-6">
            <div class="mb-3">
              <label class="form-label fw-bold">网站图标</label>
              <div class="d-flex align-items-center mb-2">
                <div class="favicon-preview me-3">
                  {% if settings.site_favicon %}
                  <img
                    src="{{ settings.site_favicon }}"
                    alt="网站图标"
                    style="max-height: 32px"
                  />
                  {% else %}
                  <div
                    class="text-center p-3 bg-light rounded"
                    style="width: 32px; height: 32px"
                  >
                    <i class="bi bi-globe" style="font-size: 16px"></i>
                  </div>
                  {% endif %}
                </div>
              </div>
              <div class="input-group mb-2">
                <span class="input-group-text"
                  ><i class="bi bi-link-45deg"></i
                ></span>
                {{ form.site_favicon(class="form-control", placeholder="Favicon
                URL") }}
              </div>
              <div class="form-text mb-2">外部图床URL或相对路径</div>
              <div class="input-group">
                <span class="input-group-text"
                  ><i class="bi bi-upload"></i
                ></span>
                {{ form.favicon_file(class="form-control") }}
              </div>
              <div class="form-text">
                推荐使用.ico、.png格式，建议尺寸为64x64像素
              </div>
            </div>
          </div>
        </div>

        <hr class="my-4" />

        <div class="mb-4">
          <label class="form-label fw-bold"
            >{{ form.footer_content.label }}</label
          >
          {{ form.footer_content(class="form-control", rows=4) }}
          <div class="form-text">
            支持HTML，可自定义页脚内容，如版权信息、备案号、友情链接等
          </div>
        </div>

        <hr class="my-4" />

        <!-- 背景设置部分 -->
        <div class="mb-4">
          <h5 class="mb-3 fw-bold">
            <i class="bi bi-palette me-2"></i>背景设置
          </h5>
          <div class="row">
            <div class="col-md-4">
              <div class="mb-3">
                {{ form.background_type.label(class="form-label") }} {{
                form.background_type(class="form-control") }}
                <div class="form-text">选择网站背景类型</div>
              </div>
              <div class="mt-3">
                <a
                  href="{{ url_for('admin.wallpaper') }}"
                  class="btn btn-outline-primary"
                >
                  <i class="bi bi-images me-1"></i> 背景管理
                </a>
              </div>
            </div>
            <div class="col-md-8">
              <div class="bg-url-container" id="bgUrlContainer">
                <div class="mb-3">
                  {{ form.background_url.label(class="form-label") }} {{
                  form.background_url(class="form-control") }}
                  <div class="form-text bg-url-help" id="bgUrlHelp">
                    背景URL或颜色代码
                  </div>
                </div>
              </div>

              <div
                class="bg-upload-container mb-3"
                id="bgUploadContainer"
                style="display: none"
              >
                {{ form.background_file.label(class="form-label") }} {{
                form.background_file(class="form-control") }}
                <div class="form-text">上传背景图片（优先使用上传）</div>
              </div>

              <div
                class="bg-preview p-3 bg-light rounded text-center"
                id="bgPreview"
                style="height: 120px"
              >
                <p class="mb-0">背景预览</p>
              </div>
            </div>
          </div>
        </div>

        <div class="mt-4 text-end">
          {{ form.submit_btn(class="btn btn-primary btn-lg px-5") }}
        </div>
      </form>
    </div>
  </div>
</div>
{% endblock %} {% block admin_scripts %}
<script>
  // 实时预览Logo和网站标题
  document.addEventListener("DOMContentLoaded", function () {
    const siteNameInput = document.getElementById("site_name");
    const logoUrlInput = document.getElementById("site_logo");
    const logoFileInput = document.getElementById("logo_file");
    const faviconUrlInput = document.getElementById("site_favicon");
    const faviconFileInput = document.getElementById("favicon_file");

    // 背景设置相关
    const bgTypeSelect = document.getElementById("background_type");
    const bgUrlInput = document.getElementById("background_url");
    const bgFileInput = document.getElementById("background_file");
    const bgUrlContainer = document.getElementById("bgUrlContainer");
    const bgUploadContainer = document.getElementById("bgUploadContainer");
    const bgUrlHelp = document.getElementById("bgUrlHelp");
    const bgPreview = document.getElementById("bgPreview");

    // 图片预览功能
    function handleFilePreview(fileInput, urlInput, previewContainer) {
      if (!fileInput) return;

      fileInput.addEventListener("change", function () {
        if (this.files && this.files[0]) {
          const reader = new FileReader();
          reader.onload = function (e) {
            let previewImg = previewContainer.querySelector("img");
            if (!previewImg) {
              previewContainer.innerHTML = "";
              previewImg = document.createElement("img");
              previewImg.style.maxHeight = previewContainer.classList.contains(
                "favicon-preview"
              )
                ? "32px"
                : "50px";
              previewContainer.appendChild(previewImg);
            }
            previewImg.src = e.target.result;
          };
          reader.readAsDataURL(this.files[0]);
        }
      });
    }

    // URL输入预览
    function handleUrlPreview(urlInput, previewContainer) {
      if (!urlInput) return;

      urlInput.addEventListener("input", function () {
        if (this.value) {
          let previewImg = previewContainer.querySelector("img");
          if (!previewImg) {
            previewContainer.innerHTML = "";
            previewImg = document.createElement("img");
            previewImg.style.maxHeight = previewContainer.classList.contains(
              "favicon-preview"
            )
              ? "32px"
              : "50px";
            previewContainer.appendChild(previewImg);
          }
          previewImg.src = this.value;
        }
      });
    }

    // 初始化预览功能
    handleFilePreview(
      logoFileInput,
      logoUrlInput,
      document.querySelector(".site-logo-preview")
    );
    handleFilePreview(
      faviconFileInput,
      faviconUrlInput,
      document.querySelector(".favicon-preview")
    );
    handleUrlPreview(
      logoUrlInput,
      document.querySelector(".site-logo-preview")
    );
    handleUrlPreview(
      faviconUrlInput,
      document.querySelector(".favicon-preview")
    );

    // 背景类型变化处理
    if (bgTypeSelect) {
      // 初始化时根据当前值设置
      updateBackgroundUI(bgTypeSelect.value);

      bgTypeSelect.addEventListener("change", function () {
        updateBackgroundUI(this.value);
      });

      // 背景文件上传预览
      if (bgFileInput) {
        bgFileInput.addEventListener("change", function () {
          if (this.files && this.files[0]) {
            const reader = new FileReader();
            reader.onload = function (e) {
              bgPreview.innerHTML = "";
              bgPreview.style.backgroundImage = `url(${e.target.result})`;
              bgPreview.style.backgroundSize = "cover";
              bgPreview.style.backgroundPosition = "center";
              bgPreview.style.height = "150px";
              bgPreview.style.width = "100%";
            };
            reader.readAsDataURL(this.files[0]);
          }
        });
      }

      // 背景URL预览
      if (bgUrlInput) {
        bgUrlInput.addEventListener("input", function () {
          updateBackgroundPreview(this.value, bgTypeSelect.value);
        });

        // 初始预览
        if (bgUrlInput.value) {
          updateBackgroundPreview(bgUrlInput.value, bgTypeSelect.value);
        }
      }
    }

    // 更新背景UI显示
    function updateBackgroundUI(type) {
      // 显示/隐藏相关字段
      if (type === "none") {
        bgUrlContainer.style.display = "none";
        bgUploadContainer.style.display = "none";

        // 重置预览
        bgPreview.style.backgroundImage = "";
        bgPreview.style.backgroundColor = "";
        bgPreview.innerHTML = '<p class="mb-0">无背景</p>';
      } else {
        bgUrlContainer.style.display = "block";

        if (type === "image") {
          bgUploadContainer.style.display = "block";
          bgUrlHelp.textContent = "背景图片URL";
        } else {
          bgUploadContainer.style.display = "none";

          if (type === "gradient") {
            bgUrlHelp.textContent =
              "渐变色代码，例如：linear-gradient(135deg, #6e8efb, #a777e3)";
          } else if (type === "color") {
            bgUrlHelp.textContent =
              "颜色代码，例如：#f5f7fa 或 rgba(245, 247, 250, 1)";
          }
        }

        // 如果有当前值，更新预览
        if (bgUrlInput.value) {
          updateBackgroundPreview(bgUrlInput.value, type);
        }
      }
    }

    // 更新背景预览
    function updateBackgroundPreview(value, type) {
      if (!value) {
        bgPreview.style.backgroundImage = "";
        bgPreview.style.backgroundColor = "";
        bgPreview.innerHTML = '<p class="mb-0">背景预览</p>';
        return;
      }

      bgPreview.innerHTML = "";

      if (type === "image") {
        bgPreview.style.backgroundImage = `url(${value})`;
        bgPreview.style.backgroundSize = "cover";
        bgPreview.style.backgroundPosition = "center";
        bgPreview.style.backgroundColor = "";
      } else if (type === "gradient") {
        bgPreview.style.backgroundImage = value;
        bgPreview.style.backgroundColor = "";
      } else if (type === "color") {
        bgPreview.style.backgroundImage = "";
        bgPreview.style.backgroundColor = value;
      }

      bgPreview.style.height = "150px";
      bgPreview.style.width = "100%";
    }
  });
</script>
{% endblock %}
