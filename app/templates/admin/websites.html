{% extends "base.html" %} {% block head %}
<meta name="csrf-token" content="{{ csrf_token() }}">
<style>
  /* 默认网站图标样式 */
  .default-site-icon {
    display: inline-flex;
    align-items: center;
    justify-content: center;
    background: linear-gradient(135deg, #6e8efb, #a777e3);
    border-radius: 4px;
    color: white;
    text-transform: uppercase;
    font-weight: bold;
    width: 24px;
    height: 24px;
    font-size: 14px;
  }
  
  /* 工具栏样式 */
  .toolbar {
    background: #f8f9fa;
    padding: 1rem;
    border-radius: 0.25rem;
    margin-bottom: 1rem;
  }
  
  /* 分页样式 */
  .pagination {
    margin: 0;
  }
  
  /* 批量操作按钮样式 */
  .batch-actions {
    display: none;
  }
  
  .batch-actions.show {
    display: block;
  }
</style>
{% endblock %} {% block content %}
<div class="container">
  <div class="row">
    <div class="col-md-3">
      <div class="admin-sidebar mb-4">
        <h5 class="mb-3">管理菜单</h5>
        <a href="{{ url_for('admin.index') }}" class="admin-sidebar-item">
          <i class="bi bi-speedometer2"></i> 仪表盘
        </a>
        <a href="{{ url_for('admin.categories') }}" class="admin-sidebar-item">
          <i class="bi bi-folder"></i> 分类管理
        </a>
        <a
          href="{{ url_for('admin.websites') }}"
          class="admin-sidebar-item active"
        >
          <i class="bi bi-globe"></i> 网站管理
        </a>
        <a href="{{ url_for('admin.invitations') }}" class="admin-sidebar-item">
          <i class="bi bi-envelope"></i> 邀请码
        </a>
        <a href="{{ url_for('admin.users') }}" class="admin-sidebar-item">
          <i class="bi bi-people"></i> 用户管理
        </a>
        <hr />
        <a href="{{ url_for('main.index') }}" class="admin-sidebar-item">
          <i class="bi bi-arrow-left"></i> 返回前台
        </a>
      </div>
    </div>
    <div class="col-md-9">
      <div class="d-flex justify-content-between align-items-center mb-4">
        <h2><i class="bi bi-globe"></i> 网站管理</h2>
        <a href="{{ url_for('admin.add_website') }}" class="btn btn-primary">
          <i class="bi bi-plus-circle"></i> 添加网站
        </a>
      </div>

      <!-- 工具栏 -->
      <div class="toolbar">
        <div class="row align-items-center">
          <div class="col-md-4">
            <select class="form-select" id="categoryFilter">
              <option value="">所有分类</option>
              {% for category in categories %}
              <option value="{{ category.id }}" {% if request.args.get('category_id')|int == category.id %}selected{% endif %}>
                {{ category.name }}
              </option>
              {% endfor %}
            </select>
          </div>
          <div class="col-md-8">
            <div class="batch-actions" id="batchActions">
              <button type="button" class="btn btn-danger btn-sm" onclick="batchDelete()">
                <i class="bi bi-trash"></i> 删除选中
              </button>
              <button type="button" class="btn btn-secondary btn-sm" onclick="togglePrivate()">
                <i class="bi bi-lock"></i> 切换私有状态
              </button>
            </div>
          </div>
        </div>
      </div>

      <div class="card">
        <div class="card-body">
          {% if websites %}
          <div class="table-responsive">
            <table class="table table-hover">
              <thead>
                <tr>
                  <th>
                    <input type="checkbox" class="form-check-input" id="selectAll">
                  </th>
                  <th>网站</th>
                  <th>分类</th>
                  <th>访问量</th>
                  <th>状态</th>
                  <th>操作</th>
                </tr>
              </thead>
              <tbody>
                {% for website in websites %}
                <tr>
                  <td>
                    <input type="checkbox" class="form-check-input website-checkbox" value="{{ website.id }}">
                  </td>
                  <td>
                    <div class="d-flex align-items-center">
                      {% if website.icon %}
                      <img
                        src="{{ website.icon }}"
                        alt="{{ website.title }}"
                        class="me-2"
                        style="width: 24px; height: 24px; object-fit: contain"
                      />
                      {% else %}
                      <i class="bi bi-globe me-2 text-primary"></i>
                      {% endif %}
                      <div>
                        <div>{{ website.title }}</div>
                        <div class="text-muted small">
                          {{ website.url|truncate(40) }}
                        </div>
                      </div>
                    </div>
                  </td>
                  <td>
                    {% if website.category %}
                    <span
                      class="badge"
                      style="background-color: {{ website.category.color or '#3498db' }};"
                    >
                      {% if website.category.icon %}
                      <i class="bi bi-{{ website.category.icon }} me-1"></i>
                      {% endif %} {{ website.category.name }}
                    </span>
                    {% else %}
                    <span class="badge bg-secondary">未分类</span>
                    {% endif %}
                  </td>
                  <td>{{ website.views }}</td>
                  <td>
                    {% if website.is_featured %}
                    <span class="badge bg-warning">推荐</span>
                    {% endif %}
                    {% if website.is_private %}
                    <span class="badge bg-danger badge-private">私有</span>
                    {% else %}
                    <span class="badge bg-success badge-public">公开</span>
                    {% endif %}
                  </td>
                  <td>
                    <a
                      href="{{ url_for('main.site', id=website.id) }}"
                      class="btn btn-sm btn-outline-secondary"
                      target="_blank"
                    >
                      <i class="bi bi-box-arrow-up-right"></i>
                    </a>
                    <a
                      href="{{ url_for('admin.edit_website', id=website.id) }}"
                      class="btn btn-sm btn-outline-primary"
                    >
                      <i class="bi bi-pencil"></i>
                    </a>
                    <a
                      href="{{ url_for('admin.delete_website', id=website.id) }}"
                      class="btn btn-sm btn-outline-danger"
                      onclick="return confirm('确定要删除此网站吗？')"
                    >
                      <i class="bi bi-trash"></i>
                    </a>
                  </td>
                </tr>
                {% endfor %}
              </tbody>
            </table>
          </div>

          <!-- 分页 -->
          {% if pagination and pagination.pages > 1 %}
          <nav class="mt-3">
            <ul class="pagination justify-content-center">
              <li class="page-item {% if not pagination.has_prev %}disabled{% endif %}">
                <a class="page-link" href="{{ url_for('admin.websites', page=pagination.prev_num, category_id=request.args.get('category_id', '')) }}">
                  <i class="bi bi-chevron-left"></i>
                </a>
              </li>
              {% for page in pagination.iter_pages() %}
                {% if page %}
                  <li class="page-item {% if page == pagination.page %}active{% endif %}">
                    <a class="page-link" href="{{ url_for('admin.websites', page=page, category_id=request.args.get('category_id', '')) }}">
                      {{ page }}
                    </a>
                  </li>
                {% else %}
                  <li class="page-item disabled">
                    <span class="page-link">...</span>
                  </li>
                {% endif %}
              {% endfor %}
              <li class="page-item {% if not pagination.has_next %}disabled{% endif %}">
                <a class="page-link" href="{{ url_for('admin.websites', page=pagination.next_num, category_id=request.args.get('category_id', '')) }}">
                  <i class="bi bi-chevron-right"></i>
                </a>
              </li>
            </ul>
          </nav>
          {% endif %}

          {% else %}
          <div class="text-center py-5">
            <i class="bi bi-emoji-frown fs-1 text-muted"></i>
            <p class="mt-3 text-muted">暂无网站数据</p>
            <a
              href="{{ url_for('admin.add_website') }}"
              class="btn btn-primary mt-2"
            >
              <i class="bi bi-plus-circle"></i> 添加第一个网站
            </a>
          </div>
          {% endif %}
        </div>
      </div>
    </div>
  </div>
</div>
{% endblock %} {% block scripts %}
<script>
  document.addEventListener("DOMContentLoaded", function () {
    // 处理网站图标加载错误
    const siteIcons = document.querySelectorAll(".d-flex img");
    siteIcons.forEach((img) => {
      img.onerror = function () {
        // 获取网站名称的第一个字母
        const siteName = this.alt;
        const firstLetter = siteName ? siteName.charAt(0).toUpperCase() : "S";

        // 创建默认图标
        const defaultIcon = document.createElement("div");
        defaultIcon.className = "default-site-icon me-2";
        defaultIcon.textContent = firstLetter;

        // 替换图像
        const parent = this.parentNode;
        parent.replaceChild(defaultIcon, this);
      };

      // 检查图片是否已经加载
      if (img.complete && (img.naturalWidth < 8 || img.naturalHeight < 8)) {
        img.onerror();
      }
    });

    // 分类筛选
    const categoryFilter = document.getElementById('categoryFilter');
    categoryFilter.addEventListener('change', function() {
      const categoryId = this.value;
      const url = new URL(window.location.href);
      if (categoryId) {
        url.searchParams.set('category_id', categoryId);
      } else {
        url.searchParams.delete('category_id');
      }
      url.searchParams.set('page', '1');  // 切换分类时重置页码
      window.location.href = url.toString();
    });

    // 全选/取消全选
    const selectAll = document.getElementById('selectAll');
    const checkboxes = document.querySelectorAll('.website-checkbox');
    const batchActions = document.getElementById('batchActions');

    selectAll.addEventListener('change', function() {
      checkboxes.forEach(checkbox => {
        checkbox.checked = this.checked;
      });
      updateBatchActions();
    });

    checkboxes.forEach(checkbox => {
      checkbox.addEventListener('change', updateBatchActions);
    });

    function updateBatchActions() {
      const checkedCount = document.querySelectorAll('.website-checkbox:checked').length;
      if (checkedCount > 0) {
        batchActions.classList.add('show');
      } else {
        batchActions.classList.remove('show');
      }
    }
  });

  // 批量删除
  function batchDelete() {
    const selectedIds = getSelectedIds();
    if (!selectedIds.length) return;
    
    if (!confirm(`确定要删除选中的 ${selectedIds.length} 个网站吗？`)) return;

    fetch('/admin/api/website/batch-delete', {
      method: 'POST',
      headers: {
        'Content-Type': 'application/json',
        'X-CSRFToken': document.querySelector('meta[name="csrf-token"]').content
      },
      body: JSON.stringify({ ids: selectedIds })
    })
    .then(response => response.json())
    .then(data => {
      if (data.success) {
        window.location.reload();
      } else {
        alert(data.message || '删除失败');
      }
    })
    .catch(error => {
      console.error('批量删除出错:', error);
      alert('操作失败，请重试');
    });
  }

  // 切换私有状态
  function togglePrivate() {
    const selectedIds = getSelectedIds();
    if (!selectedIds.length) return;

    // 获取选中项的当前状态
    const selectedItems = selectedIds.map(id => {
      const row = document.querySelector(`input[value="${id}"]`).closest('tr');
      const isPrivate = row.querySelector('.badge-private') !== null;
      return { id, isPrivate };
    });

    // 根据多数项的状态决定切换方向
    const privateCount = selectedItems.filter(item => item.isPrivate).length;
    const shouldBePrivate = privateCount <= selectedItems.length / 2;

    fetch('/admin/api/website/batch-update', {
      method: 'POST',
      headers: {
        'Content-Type': 'application/json',
        'X-CSRFToken': document.querySelector('meta[name="csrf-token"]').content
      },
      body: JSON.stringify({
        ids: selectedIds,
        data: { is_private: shouldBePrivate }
      })
    })
    .then(response => response.json())
    .then(data => {
      if (data.success) {
        window.location.reload();
      } else {
        alert(data.message || '操作失败');
      }
    })
    .catch(error => {
      console.error('批量更新出错:', error);
      alert('操作失败，请重试');
    });
  }

  // 获取选中的网站ID
  function getSelectedIds() {
    return Array.from(document.querySelectorAll('.website-checkbox:checked'))
      .map(checkbox => parseInt(checkbox.value));
  }
</script>
{% endblock %}
