<!DOCTYPE html>
<html lang="zh-CN">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <meta name="csrf-token" content="{{ csrf_token() }}" />

    {% if settings and settings.site_keywords %}
    <meta name="keywords" content="{{ settings.site_keywords }}" />
    {% endif %} {% if settings and settings.site_description %}
    <meta name="description" content="{{ settings.site_description }}" />
    {% endif %}

    <title>
      {% if title %}{{ title }} - {% endif %}{% if settings %}{{
      settings.site_name }}{% else %}炫酷导航{% endif %}
    </title>
    <!-- 引入字体图标库 -->
    <link
      rel="stylesheet"
      href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.8.0/font/bootstrap-icons.css"
    />
    <!-- 引入Bootstrap -->
    <link
      href="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/css/bootstrap.min.css"
      rel="stylesheet"
    />
    <!-- 引入动画库 -->
    <link
      rel="stylesheet"
      href="https://cdnjs.cloudflare.com/ajax/libs/animate.css/4.1.1/animate.min.css"
    />
    <!-- 自定义CSS -->
    <link
      rel="stylesheet"
      href="{{ url_for('static', filename='css/style.css') }}"
    />
    <!-- Tooltip CSS -->
    <link
      rel="stylesheet"
      href="{{ url_for('static', filename='css/tooltip.css') }}"
    />
    <!-- 回到顶部CSS -->
    <link
      rel="stylesheet"
      href="{{ url_for('static', filename='css/back-to-top.css') }}"
    />
    <!-- 页脚CSS -->
    <link
      rel="stylesheet"
      href="{{ url_for('static', filename='css/footer.css') }}"
    />
    <!-- Favicon -->
    {% if settings and settings.site_favicon %}
    <link rel="shortcut icon" href="{{ settings.site_favicon }}" />
    {% else %}
    <link
      rel="shortcut icon"
      href="{{ url_for('static', filename='images/favicon.ico') }}"
    />
    {% endif %}
    <style>
      /* 修复CSS检查器错误 */
      /* 清除所有无关样式错误 */
      @media screen {
        .dummy-class {
          color: inherit;
        }
      }

      /* 自定义Bootstrap tooltip样式 */
      .tooltip .tooltip-inner {
        background: linear-gradient(
          135deg,
          rgba(112, 73, 240, 0.95),
          rgba(87, 50, 218, 0.98)
        );
        color: white;
        font-size: 14px;
        padding: 12px 18px;
        border-radius: 12px;
        box-shadow: 0 10px 30px rgba(112, 73, 240, 0.35);
        max-width: 300px;
        border: 1px solid rgba(255, 255, 255, 0.15);
        text-shadow: 0 1px 2px rgba(0, 0, 0, 0.1);
        font-weight: 300;
        line-height: 1.5;
        text-align: justify;
        text-justify: inter-word;
      }

      /* 上方箭头颜色 */
      .tooltip.bs-tooltip-bottom .tooltip-arrow::before {
        border-bottom-color: rgba(112, 73, 240, 0.95);
      }

      /* 下方箭头颜色 */
      .tooltip.bs-tooltip-top .tooltip-arrow::before {
        border-top-color: rgba(87, 50, 218, 0.98);
      }

      /* 左侧箭头颜色 */
      .tooltip.bs-tooltip-start .tooltip-arrow::before {
        border-left-color: rgba(112, 73, 240, 0.95);
      }

      /* 右侧箭头颜色 */
      .tooltip.bs-tooltip-end .tooltip-arrow::before {
        border-right-color: rgba(112, 73, 240, 0.95);
      }

      /* 确保tooltip显示 */
      .tooltip {
        opacity: 1 !important;
        z-index: 9999 !important;
      }
    </style>
    {% block head %}{% endblock %}
  </head>
  <body
    class="{% if current_user.is_authenticated and current_user.is_admin %}user-admin{% endif %} {% block body_class %}{% endblock %}"
  >
    <main>
      {% with messages = get_flashed_messages(with_categories=true) %} {% if
      messages %}
      <div class="flash-messages">
        {% for category, message in messages %}
        <div
          class="alert alert-{{ category }} alert-dismissible fade show animate__animated animate__fadeIn"
          role="alert"
        >
          {{ message }}
          <button
            type="button"
            class="btn-close"
            data-bs-dismiss="alert"
            aria-label="Close"
          ></button>
        </div>
        {% endfor %}
      </div>
      {% endif %} {% endwith %} {% block content %}{% endblock %}
    </main>

    {% block footer %} {# 引入模块化页脚 #} {% with year = now.year %} {%
    include 'common/footer.html' %} {% endwith %} {% endblock %}

    <!-- JavaScript脚本 -->
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/js/bootstrap.bundle.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/particles.js@2.0.0/particles.min.js"></script>
    <script src="{{ url_for('static', filename='js/main.js') }}"></script>
    <!-- 回到顶部JS -->
    <script src="{{ url_for('static', filename='js/back-to-top.js') }}"></script>
    <!-- 页面底部通用JS -->
    <script>
      // 处理图标加载错误，所有页面都会执行这段代码
      document.addEventListener("DOMContentLoaded", function () {
        // 为所有网站图标添加错误处理
        function handleSiteImages() {
          const siteImages = document.querySelectorAll(
            ".site-icon img, .related-icon img"
          );
          siteImages.forEach((img) => {
            img.onerror = function () {
              const siteName = this.alt || "site";
              const firstLetter = siteName.charAt(0).toUpperCase();
              const parentEl = this.parentElement;

              // 移除错误的图片
              this.remove();

              // 创建默认图标
              const defaultIcon = document.createElement("div");
              defaultIcon.className = "default-site-icon";
              defaultIcon.textContent = firstLetter;
              parentEl.appendChild(defaultIcon);
            };

            // 检查图片是否已经加载并且是有效图标
            if (img.complete) {
              validateImage(img);
            } else {
              img.onload = function () {
                validateImage(this);
              };
            }
          });
        }

        // 验证图片是否有效
        function validateImage(img) {
          if (img.naturalWidth === 0 || img.naturalHeight === 0) {
            img.onerror();
          }
        }

        // 初始化图片处理
        handleSiteImages();

        // 监听动态加载的内容
        const observer = new MutationObserver(function (mutations) {
          mutations.forEach(function (mutation) {
            if (mutation.addedNodes.length) {
              handleSiteImages();
            }
          });
        });

        // 配置观察器
        observer.observe(document.body, {
          childList: true,
          subtree: true,
        });

        // 添加管理员模式检查日志
        if (document.body.classList.contains("user-admin")) {
          console.log("管理员模式已激活");

          // 定义一个全局函数用于调试
          window.checkCategorySorting = function () {
            console.log("检查分类排序初始化：");
            console.log(
              "- 是否管理员模式:",
              document.body.classList.contains("user-admin")
            );
            console.log(
              "- 侧边栏状态:",
              document.querySelector(".sidebar") ? "已加载" : "未加载"
            );
            const sidebarMenu = document.querySelector(
              ".sidebar-content .sidebar-group:first-child .sidebar-menu"
            );
            console.log("- 侧边栏菜单:", sidebarMenu ? "已找到" : "未找到");
            if (sidebarMenu) {
              const items = sidebarMenu.querySelectorAll(".sidebar-menu-item");
              console.log("- 菜单项数量:", items.length);
              const dataItems = sidebarMenu.querySelectorAll(
                ".sidebar-menu-item[data-id]"
              );
              console.log("- 有data-id的项:", dataItems.length);
            }
          };

          // 3秒后自动检查
          setTimeout(function () {
            if (window.checkCategorySorting) {
              window.checkCategorySorting();
            }
          }, 3000);
        }
      });
    </script>
    {% block scripts %}{% endblock %}
  </body>
</html>
